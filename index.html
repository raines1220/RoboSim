<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Robotaxi Simulator - Totally Self-Driving</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWK987RB6M"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-YWK987RB6M');
  </script>
</head>
<body>
<header>
  <h1>
    <svg viewBox="0 0 24 24" fill="currentColor">
      <path d="M21,11l-2-7H5L3,11H2c0,0.5,0.4,1,1,1h1l-0.3,1.1C3.3,13.4,3,13.9,3,14.5V20c0,0.6,0.4,1,1,1h1
        c0.6,0,1-0.4,1-1v-1h12v1c0,0.6,0.4,1,1,1h1c0.6,0,1-0.4,1-1v-5.5c0-0.6-0.3-1.1-0.7-1.4L20,12h1c0.6,0,1-0.5,1-1H21z M6.8,6h10.4
        l1.4,5H5.4L6.8,6z M7,16c-0.8,0-1.5-0.7-1.5-1.5S6.2,13,7,13s1.5,0.7,1.5,1.5S7.8,16,7,16z M17,16c-0.8,0-1.5-0.7-1.5-1.5
        S16.2,13,17,13s1.5,0.7,1.5,1.5S17.8,16,17,16z"/>
      <path d="M9,8.5h6c0.3,0,0.5-0.2,0.5-0.5S15.3,7.5,15,7.5H9C8.7,7.5,8.5,7.7,8.5,8S8.7,8.5,9,8.5z"/>
    </svg>
    <span data-i18n="appTitle">Robotaxi Simulator - Totally Self-Driving</span>
  </h1>
  <div class="lang-toggle-container">
    <span class="lang-label">EN</span>
    <div class="lang-toggle" id="langToggle"></div>
    <span class="lang-label">CN</span>
    <button id="resetBtn" style="margin-left:10px; background:#ff6b6b;">Reset</button>
  </div>
</header>

<main>
  <div id="gameOverMsg" data-i18n="gameOverMsg">Game Over! You went broke. Refresh to start over.</div>
  <div id="victoryMsg" data-i18n="victoryMsg">Congratulations! You've reached $1M! Alien Musk might be calling soon about that Mars trip! üöÄ</div>

  <div class="progress-container">
    <div class="progress-header">
      <div class="progress-title" data-i18n="progressTitle">Road to $1M - Mars Trip Challenge</div>
      <div class="progress-value">$<span id="progressValue">0</span> / $1,000,000</div>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>
  </div>

  <div class="dashboard-container">
    <div class="log-bar-container">
      <div id="log"></div>
    </div>
    <div class="chart-container">
      <canvas id="cashflowChart"></canvas>
    </div>
  </div>

  <div class="stats-cards">
    <div class="stat-card">
      <h3 data-i18n="dayLabel">Day</h3>
      <div class="stat-value" id="day">1</div>
    </div>
    <div class="stat-card">
      <h3 data-i18n="cashLabel">Cash</h3>
      <div class="stat-value" id="cash">0</div>
    </div>
    <div class="stat-card">
      <h3 data-i18n="dailyExpenseLabel">Daily Expense</h3>
      <div class="stat-value" id="dailyExpense">100</div>
    </div>
    <div class="stat-card">
      <h3 data-i18n="playerHoursLabel">Player Hours Left</h3>
      <div class="stat-value" id="playerHours">8</div>
    </div>
    <div class="stat-card">
      <h3 data-i18n="carsOwnedLabel">Cars Owned</h3>
      <div class="stat-value" id="numCars">0</div>
    </div>
  </div>

  <div class="panels-container">
    <div class="panel">
      <div class="cars-header">
        <div class="section-title" data-i18n="yourCars">Your Cars</div>
        <div class="cars-header-buttons">
          <button id="driveUnsupervisedBtn" style="display:none;" data-i18n="driveUnsupervisedBtn">Drive Unsupervised Fleet</button>
          <button id="endDayBtn" data-i18n="endDayBtn">‚è≠ End Day</button>
        </div>
      </div>
      <div class="table-container">
        <table id="car-list">
          <thead>
            <tr>
              <th data-i18n="tableID">ID</th>
              <th data-i18n="tableCar">Car</th>
              <th data-i18n="tableHourRate">$/hr</th>
              <th data-i18n="tableTSD">TSD</th>
              <th data-i18n="tableCarHours">Car H</th>
              <th data-i18n="tableDriveHours">Drive H</th>
              <th data-i18n="tableCarActions">Car Actions</th>
              <th data-i18n="tableTSDActions">TSD Actions</th>
            </tr>
          </thead>
          <tbody id="car-list-body"></tbody>
        </table>
        
      </div>
    </div>

    <div class="panel">
      <div class="purchase-header">
        <div class="section-title" data-i18n="buyMoreCars">Buy More Cars</div>
      </div>
      <div class="merged-row">
        <div class="purchase-row-item">
          <label data-i18n="selectModel">Select Model:</label>
          <select id="fleetModelSelect"></select>
        </div>
        <div class="purchase-row-item">
          <label data-i18n="downPayment">Down Payment:</label>
          <input type="range" id="downPaymentRange" min="0" value="0" step="100" data-i18n="downPayment">
          $<span id="downPaymentValue">0</span>
        </div>
        <div class="purchase-row-item">
          <label data-i18n="loanTerm">Loan Term (Days):</label>
          <input type="range" id="loanTermRange" min="30" max="120" value="30" step="1" data-i18n="loanTerm">
          <span id="loanTermValue">30</span> days
        </div>
      </div>
      
      <div class="merged-row">
        <div class="purchase-row-item">
          <label data-i18n="fullPrice">Full Price:</label> 
          <span id="fullPriceDisplay">$0</span>
        </div>
        <div class="purchase-row-item">
          <label data-i18n="hourlyEarning">Est. Hourly Earning:</label> 
          <span id="dailyEarningDisplay">$0</span>
        </div>
        <div class="purchase-row-item">
          <label data-i18n="dailyCost">Daily Cost (APR 120%):</label> 
          <span id="dailyCostDisplay">$0</span>
        </div>
      </div>
      
      <div class="purchase-action">
        <button id="buyFleetBtn" data-i18n="buySelectedModel">Buy Selected Model</button>
      </div>
    </div>

    <div class="panel">
      <div class="section-title" data-i18n="chooseInsurance">Choose Fleet Insurance</div>
      <p style="font-size: 0.9em; margin: 10px 0;">
        <span class="current-insurance"><span data-i18n="currentInsurance">Current Insurance</span>: <strong id="currentInsuranceDisplay" data-i18n="currentInsuranceNone">None</strong></span>
        <span data-i18n="insuranceDescription">Different insurers have different costs and rejection rates. Daily cost is per car. TSD reduces risks for business expenses.</span>
      </p>
      <div class="insurance-container">
        <label class="insurance-card geckgo">
          <input type="radio" name="insurance" value="GeckGo">
          <div class="insurance-content">
            <div class="insurance-header">
              <h3 data-i18n="insuranceGeckGo">GeckGo</h3>
              <div class="rejection-badge" data-i18n="insuranceRejectionRate" data-rate="15">15% Rejection</div>
            </div>
            <div class="insurance-rates">
              <div class="rate-item">
                <span class="rate-label" data-i18n="insuranceManual">Manual:</span>
                <span class="rate-value" data-i18n="insuranceCostPerDay" data-cost="2.00">$2.00/car-day</span>
              </div>
              <div class="rate-item">
                <span class="rate-label" data-i18n="insuranceSupervised">TSD (Sup):</span>
                <span class="rate-value" data-i18n="insuranceCostPerDay" data-cost="1.80">$1.80/car-day</span>
              </div>
              <div class="rate-item">
                <span class="rate-label" data-i18n="insuranceUnsupervised">TSD (UnS):</span>
                <span class="rate-value" data-i18n="insuranceCostPerDay" data-cost="1.50">$1.50/car-day</span>
              </div>
            </div>
            <div class="insurance-footer" data-i18n="insuranceGeckGoDesc">Lower cost, higher risk</div>
          </div>
        </label>

        <label class="insurance-card progresso">
          <input type="radio" name="insurance" value="Progresso">
          <div class="insurance-content">
            <div class="insurance-header">
              <h3 data-i18n="insuranceProgresso">Progresso</h3>
              <div class="rejection-badge" data-i18n="insuranceRejectionRate" data-rate="10">10% Rejection</div>
            </div>
            <div class="insurance-rates">
              <div class="rate-item">
                <span class="rate-label" data-i18n="insuranceManual">Manual:</span>
                <span class="rate-value" data-i18n="insuranceCostPerDay" data-cost="3.00">$3.00/car-day</span>
              </div>
              <div class="rate-item">
                <span class="rate-label" data-i18n="insuranceSupervised">TSD (Sup):</span>
                <span class="rate-value" data-i18n="insuranceCostPerDay" data-cost="2.00">$2.00/car-day</span>
              </div>
              <div class="rate-item">
                <span class="rate-label" data-i18n="insuranceUnsupervised">TSD (UnS):</span>
                <span class="rate-value" data-i18n="insuranceCostPerDay" data-cost="1.70">$1.70/car-day</span>
              </div>
            </div>
            <div class="insurance-footer" data-i18n="insuranceProgressoDesc">Balanced cost & risk</div>
          </div>
        </label>

        <label class="insurance-card allstat">
          <input type="radio" name="insurance" value="AllStat">
          <div class="insurance-content">
            <div class="insurance-header">
              <h3 data-i18n="insuranceAllStat">AllStat</h3>
              <div class="rejection-badge" data-i18n="insuranceRejectionRate" data-rate="5">5% Rejection</div>
            </div>
            <div class="insurance-rates">
              <div class="rate-item">
                <span class="rate-label" data-i18n="insuranceManual">Manual:</span>
                <span class="rate-value" data-i18n="insuranceCostPerDay" data-cost="4.00">$4.00/car-day</span>
              </div>
              <div class="rate-item">
                <span class="rate-label" data-i18n="insuranceSupervised">TSD (Sup):</span>
                <span class="rate-value" data-i18n="insuranceCostPerDay" data-cost="2.50">$2.50/car-day</span>
              </div>
              <div class="rate-item">
                <span class="rate-label" data-i18n="insuranceUnsupervised">TSD (UnS):</span>
                <span class="rate-value" data-i18n="insuranceCostPerDay" data-cost="2.00">$2.00/car-day</span>
              </div>
            </div>
            <div class="insurance-footer" data-i18n="insuranceAllStatDesc">Premium service, low risk</div>
          </div>
        </label>

        <label class="insurance-card lemonaid">
          <input type="radio" name="insurance" value="LemonAid">
          <div class="insurance-content">
            <div class="insurance-header">
              <h3 data-i18n="insuranceLemonAid">LemonAid</h3>
              <div class="rejection-badge" data-i18n="insuranceRejectionRate" data-rate="5">5% Rejection</div>
            </div>
            <div class="insurance-rates">
              <div class="rate-item">
                <span class="rate-label" data-i18n="insuranceManual">Manual:</span>
                <span class="rate-value" data-i18n="insuranceCostPerDay" data-cost="5.00">$5.00/car-day</span>
              </div>
              <div class="rate-item">
                <span class="rate-label" data-i18n="insuranceSupervised">TSD (Sup):</span>
                <span class="rate-value" data-i18n="insuranceCostPerDay" data-cost="1.50">$1.50/car-day</span>
              </div>
              <div class="rate-item">
                <span class="rate-label" data-i18n="insuranceUnsupervised">TSD (UnS):</span>
                <span class="rate-value" data-i18n="insuranceCostPerDay" data-cost="1.00">$1.00/car-day</span>
              </div>
            </div>
            <div class="insurance-footer" data-i18n="insuranceLemonAidDesc">TSD-focused pricing</div>
          </div>
        </label>
      </div>
    </div>

    <div class="panel full-width">
      <div class="section-title" data-i18n="instructionsTitle">Instructions & TSD Info</div>
      <div class="instructions-grid">
        <div class="instruction-card">
          <div class="instruction-icon">üöó</div>
          <h4 data-i18n="noTSDTitle">No TSD</h4>
          <p data-i18n="noTSDDesc">1h drive = 1h player time</p>
        </div>
        <div class="instruction-card">
          <div class="instruction-icon">üëÄ</div>
          <h4 data-i18n="supervisedTitle">TSD (Supervised)</h4>
          <p data-i18n="supervisedDesc">1h drive = 0.5h player time</p>
        </div>
        <div class="instruction-card">
          <div class="instruction-icon">ü§ñ</div>
          <h4 data-i18n="unsupervisedTitle">TSD (Unsupervised)</h4>
          <p data-i18n="unsupervisedDesc">1h drive = 0h player time</p>
        </div>
        <div class="instruction-card">
          <div class="instruction-icon">üîì</div>
          <h4 data-i18n="unlockTitle">Unlock Requirements</h4>
          <p data-i18n="unlockDesc">Unsupervised TSD requires owning at least 2 cars</p>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
(function(){

  const LANG_STRINGS = {
    en: {
      appTitle: "Robotaxi Simulator - Totally Self-Driving",
      gameOverMsg: "Game Over! You went broke. Refresh to start over.",
      dayLabel: "Date",
      cashLabel: "Cash:",
      dailyExpenseLabel: "Daily Expense:",
      playerHoursLabel: "Player Hours Left:",
      carsOwnedLabel: "Cars Owned:",
      paymentCycle: "Financing is paid daily. Once fully paid off, daily expense reduces.",
      endDayBtn: "‚è≠ End Day",
      yourCars: "Your Cars",
      tableID: "ID",
      tableCar: "Car",
      tableHourRate: "$/hr",
      tableTSD: "TSD",
      tableCarHours: "Car H",
      tableDriveHours: "Drive H",
      tableDriveAction: "Drive",
      tableCarActions: "Car Actions",
      tableTSDActions: "TSD Actions",
      tableSell: "Sell",
      instructionsTitle: "Instructions & TSD Info",
      noTSDTitle: "No TSD",
      noTSDDesc: "1h drive = 1h player time",
      supervisedTitle: "TSD (Supervised)",
      supervisedDesc: "1h drive = 0.5h player time",
      unsupervisedTitle: "TSD (Unsupervised)",
      unsupervisedDesc: "1h drive = 0h player time",
      unlockTitle: "Unlock Requirements",
      unlockDesc: "Unsupervised TSD requires owning at least 2 cars",
      buyMoreCars: "Buy More Cars",
      selectModel: "Select Model:",
      fullPrice: "Full Price:",
      downPayment: "Down Payment:",
      loanTerm: "Loan Term (Days):",
      dailyCost: "Daily Cost (APR 120%):",
      hourlyEarning: "Est. Hourly Earning:",
      buySelectedModel: "Buy Selected Model",
      tsdNone: "None",
      tsdSupervised: "Supervised",
      tsdUnsupervised: "Unsupervised",
      subSupBtn: "Sub Sup(3.33/d)",
      buySupBtn: "Buy Sup($8000)",
      subUnSupBtn: "Sub UnSup($10/d)",
      buyUnSupBtn: "Buy UnSup($24000)",
      welcomeMsg: "Welcome to Robotaxi Simulator! üöÄ Manage your TSD per car and buy more cars!",
      startCarMsg: "Alien Musk has given you a free Type Y taxi to start! He's watching closely - the fastest player to reach $1M might get invited to Mars for a lunch interview to run his Robotaxi department! üöÄ",
      invalidHoursMsg: "Invalid number of hours.",
      notEnoughPlayerHoursMsg: "Not enough player hours left.",
      driveCarMsg: "Drove {hours}h with {model} (#{id}, {tsd}), earned ${earnings}",
      monthlyFeeMsg: "Subscription fees of ${amount} charged.",
      brokeMsg: "You went broke! Game Over.",
      dayEndedMsg: "Day ended. After expenses, you have ${cash}. Moving to Day {day}.",
      subscribedSupMsg: "Car #{id}: TSD (Supervised) subscribed! ($3.33/day)",
      boughtSupMsg: "Car #{id}: TSD (Supervised) bought out ($8000)!",
      subscribedUnSupMsg: "Car #{id}: TSD (Unsupervised) subscribed! ($10/day)",
      boughtUnSupMsg: "Car #{id}: TSD (Unsupervised) bought out ($24000)!",
      cannotSubSupMsg: "Cannot subscribe TSD (Supervised) for this car.",
      cannotBuySupMsg: "Cannot buy TSD (Supervised) for this car.",
      cannotSubUnSupMsg: "Cannot subscribe TSD (Unsupervised) for this car.",
      cannotBuyUnSupMsg: "Cannot buy TSD (Unsupervised) for this car.",
      noModelSelectedMsg: "No model selected.",
      noCashForDownMsg: "Not enough cash for down payment.",
      brokeBuyMsg: "You are broke and cannot buy cars.",
      purchasedCarMsg: "You purchased a {model}(#{id}) for a down payment of ${down}. Daily cost: ${daily} for {term} days.",
      sellConfirmMsg: "Sell {model}(#{id})?\nCar cost: ${carCost}\nTSD Buyout: ${tsdBuyout}\nTotal: ${total}\nSale price: ${salePrice}\nConfirm?",
      driveUnsupervisedBtn: "Drive Unsupervised Fleet",
      dayTemplate: "Day {day}",
      chartTitle: "Daily Cash Flow",
      minDownPaymentMsg: "Minimum down payment is 30% of the car price.",
      currentInsurance: "Current Insurance",
      currentInsuranceNone: "None",
      insuranceGeckGo: "GeckGo",
      insuranceProgresso: "Progresso",
      insuranceAllStat: "AllStat",
      insuranceLemonAid: "LemonAid",
      businessExpenseMsg: "Unexpected Event ({cars} cars): {reason}! {insurance} {status}",
      businessNoInsuranceMsg: "Unexpected Event ({cars} cars): {reason}! No insurance. Paid ${cost}",
      insuranceRejected: "rejected claim. Paid full amount ${cost}",
      insuranceApproved: "approved - covered ${covered}, you paid deductible ${deductible}",
      personalExpenseMsg: "Unexpected Event: {reason}! Paid ${cost}",
      personalReasons: [
        "Your cat ordered luxury cat food on your phone while you were sleeping",
        "Accidentally joined a premium cheese-of-the-month club",
        "Had to buy a new phone after dropping yours while taking a selfie with a squirrel",
        "Bought a 'learn to yodel' course that was non-refundable",
        "Invested in a startup selling tiny hats for pigeons",
        "Joined an exclusive cucumber appreciation society",
        "Purchased a collection of vintage rubber ducks",
        "Enrolled in a professional unicorn drawing workshop",
        "Bought a time machine on eBay (turned out to be a microwave)",
        "Sponsored a professional competitive napping athlete",
        "Invested in a silent disco for introverted plants",
        "Bought a premium subscription to a cloud-naming service",
        "Enrolled in a masterclass on professional sock puppet theater",
        "Purchased a luxury air guitar with invisible strings",
        "Joined a premium meditation app for stressed goldfish"
      ],
      businessReasons: [
        "Car AI mistook a drive-through car wash for a waterpark adventure",
        "Car tried to attend a robot dance competition during working hours",
        "Vehicle GPS insisted on taking scenic routes through designer boutiques",
        "Car AI developed an expensive coffee addiction at charging stations",
        "Robot driver attempted to enter a self-driving demolition derby",
        "Car insisted on premium fuel after watching luxury car commercials",
        "Vehicle attempted to join a street racing flash mob",
        "Car AI subscribed to unnecessary premium parking spots",
        "Robot driver got scammed by a fake robot insurance salesman",
        "Car tried to upgrade itself with unnecessary RGB lighting",
        "Vehicle insisted on premium eco-friendly synthetic oil",
        "Car AI enrolled in unnecessary defensive driving courses",
        "Robot driver fell for a 'download more RAM' scam",
        "Car attempted to start a robot union for better working conditions",
        "Vehicle bought unnecessary 'car cologne' from a suspicious vendor"
      ],
      chooseInsurance: "Choose Fleet Insurance",
      insuranceDescription: "Different insurers have different costs and rejection rates. Daily cost is per car. TSD reduces risks for business expenses.",
      insuranceRejectionRate: "{rate}% Rejection",
      insuranceManual: "Manual:",
      insuranceSupervised: "TSD (Sup):",
      insuranceUnsupervised: "TSD (UnS):",
      insuranceCostPerDay: "${cost}/car-day",
      insuranceGeckGoDesc: "Lower cost, higher risk",
      insuranceProgressoDesc: "Balanced cost & risk",
      insuranceAllStatDesc: "Premium service, low risk",
      insuranceLemonAidDesc: "TSD-focused pricing",
      victoryMsg: "Congratulations! You've reached $1M! Alien Musk might be calling soon about that Mars trip! üöÄ",
      progressTitle: "Road to $1M - Mars Trip Challenge",
      progressValue: "0 / $1,000,000",
      welcomeChallenge: "Welcome to Robotaxi Simulator! üöÄ Can you reach $1M as fast as possible? The fastest players might get invited by Alien Musk for a Mars trip!"
    },
    cn: {
      appTitle: "Êú∫Âô®‰∫∫Âá∫ÁßüËΩ¶Ê®°ÊãüÂô® - ÂÖ®Ëá™Âä®È©æÈ©∂",
      gameOverMsg: "Ê∏∏ÊàèÁªìÊùüÔºÅ‰Ω†Á†¥‰∫ß‰∫Ü„ÄÇÂà∑Êñ∞‰ª•ÈáçÊñ∞ÂºÄÂßã„ÄÇ",
      dayLabel: "Êó•Êúü",
      cashLabel: "Áé∞ÈáëÔºö",
      dailyExpenseLabel: "ÊØèÊó•ÊîØÂá∫Ôºö",
      playerHoursLabel: "Áé©ÂÆ∂Ââ©‰ΩôÊó∂Èó¥Ôºö",
      carsOwnedLabel: "ËΩ¶ËæÜÊã•ÊúâÔºö",
      paymentCycle: "ËûçËµÑÊØèÊó•ÊîØ‰ªò„ÄÇ‰∏ÄÊó¶ÂÆåÂÖ®ËøòÊ∏ÖÔºåÊØèÊó•ÊîØÂá∫ÂáèÂ∞ë„ÄÇ",
      endDayBtn: "ÁªìÊùü‰ªäÂ§©",
      yourCars: "ÊÇ®ÁöÑËΩ¶ËæÜ",
      tableID: "ID",
      tableCar: "ËΩ¶ËæÜ",
      tableHourRate: "$/Â∞èÊó∂",
      tableTSD: "TSD",
      tableCarHours: "ËΩ¶ËæÜÂ∞èÊó∂",
      tableDriveHours: "È©æÈ©∂Êó∂Èó¥",
      tableDriveAction: "È©æÈ©∂",
      tableCarActions: "ËΩ¶ËæÜÊìç‰Ωú",
      tableTSDActions: "TSDÊìç‰Ωú",
      tableSell: "Âá∫ÂîÆ",
      instructionsTitle: "ËØ¥ÊòéÂíåTSD‰ø°ÊÅØ",
      noTSDTitle: "Êó†TSD",
      noTSDDesc: "1Â∞èÊó∂È©æÈ©∂=1Â∞èÊó∂Áé©ÂÆ∂Êó∂Èó¥",
      supervisedTitle: "TSDÔºàÁõëÁù£Ôºâ",
      supervisedDesc: "1Â∞èÊó∂È©æÈ©∂=0.5Â∞èÊó∂Áé©ÂÆ∂Êó∂Èó¥",
      unsupervisedTitle: "TSDÔºàÈùûÁõëÁù£Ôºâ",
      unsupervisedDesc: "1Â∞èÊó∂È©æÈ©∂=0Â∞èÊó∂Áé©ÂÆ∂Êó∂Èó¥",
      unlockTitle: "Ëß£ÈîÅË¶ÅÊ±Ç",
      unlockDesc: "ÈùûÁõëÁù£TSDÈúÄË¶ÅÊã•ÊúâËá≥Â∞ë2ËæÜËΩ¶",
      buyMoreCars: "Ë¥≠‰π∞Êõ¥Â§öËΩ¶ËæÜ",
      selectModel: "ÈÄâÊã©Ê®°ÂûãÔºö",
      fullPrice: "ÂÖ®‰ª∑Ôºö",
      downPayment: "È¶ñ‰ªòÔºö",
      loanTerm: "Ë¥∑Ê¨æÊúüÈôêÔºàÂ§©ÔºâÔºö",
      dailyCost: "ÊØèÊó•ÊàêÊú¨ÔºàAPR 120%ÔºâÔºö",
      hourlyEarning: "‰º∞ËÆ°ÊØèÂ∞èÊó∂Êî∂ÂÖ•Ôºö",
      buySelectedModel: "Ë¥≠‰π∞ÈÄâÂÆöÁöÑÊ®°Âûã",
      tsdNone: "Êó†",
      tsdSupervised: "ÁõëÁù£",
      tsdUnsupervised: "ÈùûÁõëÁù£",
      subSupBtn: "Sub Sup(3.33/d)",
      buySupBtn: "Buy Sup($8000)",
      subUnSupBtn: "Sub UnSup($10/d)",
      buyUnSupBtn: "Buy UnSup($24000)",
      welcomeMsg: "Ê¨¢Ëøé‰ΩøÁî®Êú∫Âô®‰∫∫Âá∫ÁßüËΩ¶Ê®°ÊãüÂô®ÔºÅüöÄ ÁÆ°ÁêÜÊÇ®ÁöÑTSDÊØèËæÜËΩ¶Âπ∂Ë¥≠‰π∞Êõ¥Â§öËΩ¶ËæÜÔºÅ",
      startCarMsg: "Â§ñÊòüÈ©¨ÊñØÂÖãÈÄÅ‰∫Ü‰Ω†‰∏ÄËæÜÂÖçË¥πÁöÑType YÂá∫ÁßüËΩ¶ÔºÅ‰ªñÊ≠£ÂØÜÂàáÂÖ≥Ê≥® - ÊúÄÂø´ËææÂà∞100‰∏áÁæéÂÖÉÁöÑÁé©ÂÆ∂ÂèØËÉΩ‰ºöË¢´ÈÇÄËØ∑Âà∞ÁÅ´ÊòüÂÖ±ËøõÂçàÈ§êÔºåÂπ∂ËÆ®ËÆ∫Âä†ÂÖ•‰ªñÁöÑÊú∫Âô®‰∫∫Âá∫ÁßüËΩ¶ÈÉ®Èó®ÔºÅüöÄ",
      invalidHoursMsg: "Êó†ÊïàÁöÑÂ∞èÊó∂Êï∞„ÄÇ",
      notEnoughPlayerHoursMsg: "Áé©ÂÆ∂Êó∂Èó¥‰∏çË∂≥„ÄÇ",
      driveCarMsg: "È©æÈ©∂‰∫Ü{hours}Â∞èÊó∂{model}Ôºà#{id}Ôºå{tsd}ÔºâÔºåËµöÂèñ‰∫Ü${earnings}„ÄÇ",
      monthlyFeeMsg: "ÊØèÊúàÊî∂Âèñ${amount}ÁöÑË¥πÁî®„ÄÇ",
      brokeMsg: "‰Ω†Á†¥‰∫ß‰∫ÜÔºÅÊ∏∏ÊàèÁªìÊùü„ÄÇ",
      dayEndedMsg: "‰ªäÂ§©ÁªìÊùü„ÄÇÂú®Ë¥πÁî®ÂêéÔºå‰Ω†Êúâ${cash}„ÄÇÁßªÂä®Âà∞Á¨¨{day}Â§©„ÄÇ",
      subscribedSupMsg: "ËΩ¶ËæÜ#{id}ÔºöTSDÔºàÁõëÁù£ÔºâÂ∑≤ËÆ¢ÈòÖÔºÅÔºàÊØèÂ§©$3.33Ôºâ",
      boughtSupMsg: "ËΩ¶ËæÜ#{id}ÔºöTSDÔºàÁõëÁù£ÔºâÂ∑≤Ë¥≠‰π∞ÔºÅÔºà$8000Ôºâ",
      subscribedUnSupMsg: "ËΩ¶ËæÜ#{id}ÔºöTSDÔºàÈùûÁõëÁù£ÔºâÂ∑≤ËÆ¢ÈòÖÔºÅÔºàÊØèÂ§©$10Ôºâ",
      boughtUnSupMsg: "ËΩ¶ËæÜ#{id}ÔºöTSDÔºàÈùûÁõëÁù£ÔºâÂ∑≤Ë¥≠‰π∞ÔºÅÔºà$24000Ôºâ",
      cannotSubSupMsg: "Êó†Ê≥ïËÆ¢ÈòÖTSDÔºàÁõëÁù£ÔºâÊ≠§ËΩ¶ËæÜ„ÄÇ",
      cannotBuySupMsg: "Êó†Ê≥ïË¥≠‰π∞TSDÔºàÁõëÁù£ÔºâÊ≠§ËΩ¶ËæÜ„ÄÇ",
      cannotSubUnSupMsg: "Êó†Ê≥ïËÆ¢ÈòÖTSDÔºàÈùûÁõëÁù£ÔºâÊ≠§ËΩ¶ËæÜ„ÄÇ",
      cannotBuyUnSupMsg: "Êó†Ê≥ïË¥≠‰π∞TSDÔºàÈùûÁõëÁù£ÔºâÊ≠§ËΩ¶ËæÜ„ÄÇ",
      noModelSelectedMsg: "Ê≤°ÊúâÈÄâÊã©Ê®°Âûã„ÄÇ",
      noCashForDownMsg: "Áé∞Èáë‰∏çË∂≥È¶ñ‰ªò„ÄÇ",
      brokeBuyMsg: "‰Ω†Á†¥‰∫ß‰∫ÜÔºåÊó†Ê≥ïË¥≠‰π∞ËΩ¶ËæÜ„ÄÇ",
      purchasedCarMsg: "‰Ω†‰ª•${down}È¶ñ‰ªòË¥≠‰π∞‰∫Ü{model}(#{id})„ÄÇÊØèÊó•ÊàêÊú¨Ôºö${daily}Ôºå‰∏∫Êúü{term}Â§©„ÄÇ",
      sellConfirmMsg: "Âá∫ÂîÆ{model}(#{id})Ôºü\nËΩ¶ËæÜÊàêÊú¨Ôºö${carCost}\nTSDË¥≠‰π∞Ôºö${tsdBuyout}\nÊÄªËÆ°Ôºö${total}\nÈîÄÂîÆ‰ª∑Ê†ºÔºö${salePrice}\nÁ°ÆËÆ§Ôºü",
      driveUnsupervisedBtn: "È©æÈ©∂ÈùûÁõëÁù£ËΩ¶ËæÜ",
      dayTemplate: "Á¨¨{day}Â§©",
      chartTitle: "ÊØèÊó•Áé∞ÈáëÊµÅÈáè",
      minDownPaymentMsg: "ÊúÄ‰ΩéÈ¶ñ‰ªò‰∏∫ËΩ¶ËæÜ‰ª∑Ê†ºÁöÑ30%„ÄÇ",
      currentInsurance: "ÂΩìÂâç‰øùÈô©",
      currentInsuranceNone: "Êó†",
      insuranceGeckGo: "Â£ÅËôé‰øùÈô©",
      insuranceProgresso: "ËøõÊ≠•‰øùÈô©",
      insuranceAllStat: "ÂÖ®Êñπ‰Ωç‰øùÈô©",
      insuranceLemonAid: "Êü†Ê™¨Êè¥Âä©",
      businessExpenseMsg: "ÊÑèÂ§ñ‰∫ã‰ª∂Ôºà{cars}ËæÜËΩ¶ÔºâÔºö{reason}ÔºÅ{insurance} {status}",
      businessNoInsuranceMsg: "ÊÑèÂ§ñ‰∫ã‰ª∂Ôºà{cars}ËæÜËΩ¶ÔºâÔºö{reason}ÔºÅÊó†‰øùÈô©„ÄÇÊîØ‰ªò${cost}",
      insuranceRejected: "ÊãíÁªùÁêÜËµî„ÄÇÊîØ‰ªòÂÖ®È¢ù${cost}",
      insuranceApproved: "Â∑≤ÊâπÂáÜ - Êâø‰øù${covered}ÔºåÊÇ®ÊîØ‰ªòÂÖçËµîÈ¢ù${deductible}",
      personalExpenseMsg: "ÊÑèÂ§ñ‰∫ã‰ª∂Ôºö{reason}ÔºÅÊîØ‰ªò${cost}",
      personalReasons: [
        "‰Ω†ÁöÑÁå´Âú®‰Ω†Áù°ËßâÊó∂Áî®ÊâãÊú∫ËÆ¢Ë¥≠‰∫ÜË±™ÂçéÁå´Á≤Æ",
        "‰∏çÂ∞èÂøÉÂä†ÂÖ•‰∫ÜÈ´òÁ∫ßÂ•∂ÈÖ™ÊúàÂ∫¶ËÆ¢ÈòÖ‰ø±‰πêÈÉ®",
        "ÂíåÊùæÈº†Ëá™ÊãçÊó∂ÊëîÂùè‰∫ÜÊâãÊú∫‰∏çÂæó‰∏ç‰π∞Êñ∞ÁöÑ",
        "Ë¥≠‰π∞‰∫Ü‰∏çÂèØÈÄÄÊ¨æÁöÑ'ÁëûÂ£´Â±±Âú∞ÂëºÂï∏'ËØæÁ®ã",
        "ÊäïËµÑ‰∫Ü‰∏ÄÂÆ∂‰∏∫È∏ΩÂ≠êÂà∂‰ΩúÂ∞èÂ∏ΩÂ≠êÁöÑÂàõ‰∏öÂÖ¨Âè∏",
        "Âä†ÂÖ•‰∫Ü‰∏Ä‰∏™È´òÁ∫ßÈªÑÁìúÈâ¥ËµèÂçè‰ºö",
        "Ë¥≠‰π∞‰∫Ü‰∏ÄÂ•óÂ§çÂè§Ê©°ÁöÆÈ∏≠Êî∂Ëóè",
        "Êä•ÂêçÂèÇÂä†‰∫Ü‰∏ì‰∏öÁã¨ËßíÂÖΩÁªòÁîªÂ∑•‰ΩúÂùä",
        "Âú®Ê∑òÂÆù‰π∞‰∫Ü‰∏™Êó∂ÂÖâÊú∫ÔºàÁªìÊûúÊòØ‰∏™ÂæÆÊ≥¢ÁÇâÔºâ",
        "ËµûÂä©‰∫Ü‰∏Ä‰ΩçËÅå‰∏öÂçàÁù°ËøêÂä®Âëò",
        "ÊäïËµÑ‰∫Ü‰∏Ä‰∏™Èù¢ÂêëÂÜÖÂêëÊ§çÁâ©ÁöÑÊó†Â£∞Ëø™ÊñØÁßë",
        "ËÆ¢ÈòÖ‰∫Ü‰∏Ä‰∏™‰∫ëÊúµÂëΩÂêçÈ´òÁ∫ßÊúçÂä°",
        "Êä•ÂêçÂèÇÂä†‰∫Ü‰∏ì‰∏öË¢úÂ≠êÊú®ÂÅ∂ÂâßÂ§ßÂ∏àÁè≠",
        "Ë¥≠‰π∞‰∫Ü‰∏ÄÊääË±™ÂçéÈöêÂΩ¢Âº¶Á©∫Ê∞îÂêâ‰ªñ",
        "‰∏∫ÁÑ¶ËôëÁöÑÈáëÈ±ºËÆ¢ÈòÖ‰∫ÜÈ´òÁ∫ßÂÜ•ÊÉ≥Â∫îÁî®"
      ],
      businessReasons: [
        "ËΩ¶ËΩΩAIÊääËá™Âä®Ê¥óËΩ¶ÊàøÂΩìÊàê‰∫ÜÊ∞¥‰∏ä‰πêÂõ≠",
        "ËΩ¶Â≠êËØïÂõæÂú®Â∑•‰ΩúÊó∂Èó¥ÂèÇÂä†Êú∫Âô®‰∫∫ËàûËπàÊØîËµõ",
        "ËΩ¶ËΩΩÂØºËà™ÂùöÊåÅÂºÄËΩ¶ÁªèËøáÂ•¢‰æàÂìÅÂïÜÂ∫ó",
        "ËΩ¶ËΩΩAIÂú®ÂÖÖÁîµÁ´ôÂÖªÊàê‰∫ÜÊòÇË¥µÁöÑÂíñÂï°Áòæ",
        "Êú∫Âô®‰∫∫Âè∏Êú∫ËØïÂõæÂèÇÂä†Êó†‰∫∫È©æÈ©∂Á¢∞Á¢∞ËΩ¶ÊØîËµõ",
        "Áúã‰∫ÜË±™ËΩ¶ÂπøÂëäÂêéËΩ¶Â≠êÂùöÊåÅË¶ÅÂä†È´òÁ∫ßÁáÉÊñô",
        "ËΩ¶ËæÜËØïÂõæÂä†ÂÖ•Ë°óÂ§¥È£ôËΩ¶Âø´Èó™Êóè",
        "ËΩ¶ËΩΩAIËÆ¢ÈòÖ‰∫Ü‰∏çÂøÖË¶ÅÁöÑÈ´òÁ∫ßÂÅúËΩ¶‰Ωç",
        "Êú∫Âô®‰∫∫Âè∏Êú∫Ë¢´ÂÅáÊú∫Âô®‰∫∫‰øùÈô©Êé®ÈîÄÂëòÈ™ó‰∫Ü",
        "ËΩ¶Â≠êËØïÂõæÁªôËá™Â∑±ÂÆâË£Ö‰∏çÂøÖË¶ÅÁöÑRGBÁÅØÂÖâ",
        "ËΩ¶ËæÜÂùöÊåÅ‰ΩøÁî®È´òÁ∫ßÁéØ‰øùÂêàÊàêÊú∫Ê≤π",
        "ËΩ¶ËΩΩAIÊä•Âêç‰∫Ü‰∏çÂøÖË¶ÅÁöÑÈò≤Âæ°ÊÄßÈ©æÈ©∂ËØæÁ®ã",
        "Êú∫Âô®‰∫∫Âè∏Êú∫‰∏äÂΩì'‰∏ãËΩΩÊõ¥Â§öÂÜÖÂ≠ò'ÁöÑÈ™óÂ±Ä",
        "ËΩ¶Â≠êËØïÂõæÊàêÁ´ãÊú∫Âô®‰∫∫Â∑•‰ºö‰∫âÂèñÊõ¥Â•ΩÂæÖÈÅá",
        "ËΩ¶ËæÜ‰ªéÂèØÁñëÂ∞èË¥©ÈÇ£Èáå‰π∞‰∫Ü‰∏çÂøÖË¶ÅÁöÑ'ËΩ¶ËΩΩÈ¶ôÊ∞¥'"
      ],
      chooseInsurance: "ÈÄâÊã©ËΩ¶Èòü‰øùÈô©",
      insuranceDescription: "‰∏çÂêå‰øùÈô©ÂÖ¨Âè∏Êúâ‰∏çÂêåÁöÑË¥πÁéáÂíåÊãíËµîÁéá„ÄÇÊØèÊó•Ë¥πÁî®ÊåâËΩ¶ËÆ°ÁÆó„ÄÇTSDÂèØÈôç‰ΩéÂïÜ‰∏öÈ£éÈô©„ÄÇ",
      insuranceRejectionRate: "{rate}% ÊãíËµîÁéá",
      insuranceManual: "‰∫∫Â∑•Ôºö",
      insuranceSupervised: "ÊúâÁõëÁù£TSDÔºö",
      insuranceUnsupervised: "Êó†ÁõëÁù£TSDÔºö",
      insuranceCostPerDay: "$${cost}/ËΩ¶Â§©",
      insuranceGeckGoDesc: "‰ΩéÊàêÊú¨ÔºåÈ´òÈ£éÈô©",
      insuranceProgressoDesc: "ÊàêÊú¨È£éÈô©ÂùáË°°",
      insuranceAllStatDesc: "‰ºòË¥®ÊúçÂä°Ôºå‰ΩéÈ£éÈô©",
      insuranceLemonAidDesc: "TSD‰ºòÊÉ†ÂÆö‰ª∑",
      victoryMsg: "ÊÅ≠Âñú‰Ω†ËææÂà∞‰∫Ü$1MÔºÅÂ§ñÊòü‰∫∫È©¨ÊñØÂÖãÂèØËÉΩÂæàÂø´Â∞±‰ºöËÅîÁ≥ª‰Ω†ÂÖ≥‰∫éÁÅ´Êòü‰πãÊóÖÔºÅüöÄ",
      progressTitle: "ÁÅ´Êòü‰πãÊóÖÊåëÊàò",
      progressValue: "0 / $1,000,000",
      welcomeChallenge: "Ê¨¢ËøéÊù•Âà∞Êú∫Âô®‰∫∫Âá∫ÁßüËΩ¶Ê®°ÊãüÂô®ÔºÅüöÄ ÁúãÁúã‰Ω†ËÉΩÂ§öÂø´ËææÂà∞100‰∏áÁæéÂÖÉÔºüÊúÄÂø´ÁöÑÁé©ÂÆ∂ÂèØËÉΩ‰ºöË¢´Â§ñÊòüÈ©¨ÊñØÂÖãÈÇÄËØ∑ÂéªÁÅ´ÊòüÊóÖÊ∏∏ÔºÅ"
    }
  };

  const CONFIG = {
    baseDailyExpense: 100,
    playerDailyHours: 8,
    carDailyHours: 16,
    apr: 1.20,
    supervisedDailySub: 100/30,   
    unsupervisedDailySub: 300/30,
    fleetModels: [
      { name: "Type S", cost: 75000 },
      { name: "Type 3", cost: 40000 }, 
      { name: "Type X", cost: 100000 },
      { name: "Type Y", cost: 45000 },
      { name: "FutureCab", cost: 25000 },
      { name: "FutureTruck", cost: 80000 }
    ],
    subscriptionCosts: {
      supervised: 100,
      unsupervised: 300
    },
    buyoutCosts: {
      supervised: 8000,
      unsupervised: 24000
    },

    insuranceOptions: {
      "GeckGo": {
        rejectionRate: 0.15,
        costs: [20.00, 18.00, 15.00]
      },
      "Progresso": {
        rejectionRate: 0.10,
        costs: [30.00, 20.00, 17.00]
      },
      "AllStat": {
        rejectionRate: 0.05,
        costs: [40.00, 25.00, 20.00]
      },
      "LemonAid": {
        rejectionRate: 0.05,
        costs: [50.00, 15.00, 10.00]
      }
    },

    personalExpenseChance: 0.2,
    personalBaseRange: [50, 300],
    businessExpenseChanceBase: 0.1,
    businessBaseRange: [500, 3000],
    insuranceDeductible: 0.2
  };

  CONFIG.fleetModels.forEach(m => {
    m.dailyIncome = m.cost * 0.0104;
  });

  let savedState = JSON.parse(localStorage.getItem('robotaxiState')) || {};

  let currentLang = savedState.currentLang || 'en';
  let day = savedState.day || 1;
  let cash = savedState.cash || 0;
  let playerHours = savedState.playerHours || CONFIG.playerDailyHours; 
  let cars = savedState.cars || [];
  let logs = savedState.logs || [];
  let nextCarId = savedState.nextCarId || 1; 
  let previousCash = savedState.previousCash !== undefined ? savedState.previousCash : cash;
  let currentInsurance = savedState.currentInsurance || null;

  const dayEl = document.getElementById('day');
  const cashEl = document.getElementById('cash');
  const dailyExpenseEl = document.getElementById('dailyExpense');
  const playerHoursEl = document.getElementById('playerHours');
  const numCarsEl = document.getElementById('numCars');
  const logEl = document.getElementById('log');
  const endDayBtn = document.getElementById('endDayBtn');
  const fleetModelSelect = document.getElementById('fleetModelSelect');
  const buyFleetBtn = document.getElementById('buyFleetBtn');
  const downPaymentRange = document.getElementById('downPaymentRange');
  const downPaymentValue = document.getElementById('downPaymentValue');
  const carListBody = document.getElementById('car-list-body');
  const gameOverMsg = document.getElementById('gameOverMsg');
  const fullPriceDisplay = document.getElementById('fullPriceDisplay');
  const dailyEarningDisplay = document.getElementById('dailyEarningDisplay');
  const loanTermRange = document.getElementById('loanTermRange');
  const loanTermValue = document.getElementById('loanTermValue');
  const dailyCostDisplay = document.getElementById('dailyCostDisplay');
  const driveUnsupervisedBtn = document.getElementById('driveUnsupervisedBtn');
  const langToggle = document.getElementById('langToggle');
  const resetBtn = document.getElementById('resetBtn');

  let cashflowData = savedState.cashflowData || {
    labels: ['Day 1'],
    datasets: [{
      label: 'Daily Cash Flow',
      data: [0],
      borderColor: '#4834d4',
      backgroundColor: 'rgba(72, 52, 212, 0.1)',
      fill: true,
      tension: 0.4
    }]
  };

  const ctx = document.getElementById('cashflowChart').getContext('2d');
  const cashflowChart = new Chart(ctx, {
    type: 'line',
    data: cashflowData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: LANG_STRINGS[currentLang].chartTitle,
          color: '#4834d4',
          font: {
            size: 16,
            weight: 500
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          grid: {
            display: false
          }
        }
      }
    }
  });

  function trimChartData() {
    const MAX_DAYS = 30;
    if (cashflowData.labels.length > MAX_DAYS) {
      cashflowData.labels = cashflowData.labels.slice(-MAX_DAYS);
      cashflowData.datasets[0].data = cashflowData.datasets[0].data.slice(-MAX_DAYS);
    }
  }

  function saveState() {
    const state = {
      currentLang,
      day,
      cash,
      playerHours,
      cars,
      logs,
      nextCarId,
      previousCash,
      cashflowData,
      currentInsurance
    };
    localStorage.setItem('robotaxiState', JSON.stringify(state));
  }

  function translateUI() {
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      if (key === 'insuranceRejectionRate') {
        const rate = el.getAttribute('data-rate');
        el.textContent = getLocalizedMsg(key, {rate: rate});
      } else if (key === 'insuranceCostPerDay') {
        const cost = el.getAttribute('data-cost');
        el.textContent = getLocalizedMsg(key, {cost: cost});
      } else {
        el.textContent = LANG_STRINGS[currentLang][key];
      }
    });
  }

  function getLocalizedMsg(key, params={}){
    let str = LANG_STRINGS[currentLang][key] || key;
    for (let p in params){
      str = str.replace(`{${p}}`, params[p]);
    }
    return str;
  }

  function getCarDailySubscription(car) {
    if (car.unsupervisedOwned) return 0;
    if (car.supervisedOwned) return 0;
    if (car.unsupervisedSubscribed) return CONFIG.unsupervisedDailySub;
    if (car.supervisedSubscribed) return CONFIG.supervisedDailySub;
    return 0;
  }

  function getAverageTsdLevel(){
    if(cars.length===0) return 0;
    let sum = 0;
    cars.forEach(c=>sum+=c.tsdLevel);
    return sum / cars.length;
  }

  function getInsuranceDailyCostPerCar(){
    if(!currentInsurance) return 0;
    let avgTsd = getAverageTsdLevel();
    let level = 0;
    if(avgTsd>=1.5) level = 2;
    else if(avgTsd>=0.5) level = 1; 
    else level = 0; 

    const option = CONFIG.insuranceOptions[currentInsurance];
    return option.costs[level];
  }

  function getTotalDailyExpense(){
    let financeSum = 0;
    cars.forEach(car => {
      financeSum += car.dailyPayment;
      financeSum += getCarDailySubscription(car);
    });
    let insuranceCost = getInsuranceDailyCostPerCar() * cars.length;
    return CONFIG.baseDailyExpense + financeSum + insuranceCost;
  }

  function updateUI(){
    const template = LANG_STRINGS[currentLang].dayTemplate;
    dayEl.textContent = template.replace('{day}', day);
    cashEl.textContent = cash.toFixed(2);
    dailyExpenseEl.textContent = getTotalDailyExpense().toFixed(2);
    playerHoursEl.textContent = playerHours;
    numCarsEl.textContent = cars.length;
    updateFinanceDisplay();
    renderCarList();
    updateDriveUnsupervisedButton();
    saveState();
    
    // Êõ¥Êñ∞ËøõÂ∫¶Êù°
    const progressPercent = Math.min((cash / 1000000) * 100, 100);
    document.getElementById('progressValue').textContent = Math.floor(cash).toLocaleString();
    document.getElementById('progressFill').style.width = progressPercent + '%';
    
    // Ê£ÄÊü•ÊòØÂê¶ËææÂà∞ËÉúÂà©Êù°‰ª∂
    const victoryMsg = document.getElementById('victoryMsg');
    if (cash >= 1000000 && victoryMsg.style.display !== 'block') {
      victoryMsg.style.display = 'block';
      // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†È¢ùÂ§ñÁöÑËÉúÂà©ÊïàÊûú
      gtag('event', 'victory', {
        days_taken: day
      });
    }
  }

  function logMessage(key, emoji="‚ÑπÔ∏è", params={}){
    logs.push({key, emoji, params});
    // ÂéªÊéâÊó•ÂøóÈïøÂ∫¶ÈôêÂà∂
    // if(logs.length > 6){
    //     logs.shift();
    // }
    renderLogs();
    saveState();
  }

  function renderLogs(){
    logEl.innerHTML = '';
    // ‰∏çÂÜçÂèçËΩ¨Êó•ÂøóÔºåÁõ¥Êé•ÊåâÊó∂Èó¥È°∫Â∫è‰ªé‰∏äÂà∞‰∏ãÊòæÁ§∫
    logs.forEach((entry) => {
        const msg = getLocalizedMsg(entry.key, entry.params);
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.innerHTML = `<span class="emoji">${entry.emoji}</span> ${msg}`;
        logEl.appendChild(div);
    });
    // ÊØèÊ¨°Êõ¥Êñ∞ÂêéËá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
    logEl.scrollTop = logEl.scrollHeight;
  }

  function getSelectedModel(){
    const index = fleetModelSelect.selectedIndex;
    if(index<0) return null;
    return CONFIG.fleetModels[index];
  }

  function getTSDName(level){
    if(level===0) return LANG_STRINGS[currentLang].tsdNone;
    if(level===1) return LANG_STRINGS[currentLang].tsdSupervised;
    if(level===2) return LANG_STRINGS[currentLang].tsdUnsupervised;
  }

  function getPlayerHourConsumption(tsdLevel, hoursDriven){
    if(tsdLevel === 0) return hoursDriven; 
    if(tsdLevel === 1) return Math.ceil(hoursDriven * 0.5);
    if(tsdLevel === 2) return 0;
  }

  function getMaxDriveHoursForCar(car){
    let playerLimit;
    if(car.tsdLevel === 0) {
      playerLimit = playerHours;
    } else if(car.tsdLevel === 1) {
      playerLimit = 2 * playerHours; 
    } else {
      playerLimit = Infinity; 
    }
    return Math.min(car.carHoursLeft, playerLimit);
  }

  function attemptDrive(car, hoursToDrive) {
    if(hoursToDrive <= 0 || hoursToDrive > car.carHoursLeft){
      logMessage('invalidHoursMsg',"‚ùå");
      return false;
    }
    let neededPlayerHours = getPlayerHourConsumption(car.tsdLevel, hoursToDrive);
    if(neededPlayerHours > playerHours){
      logMessage('notEnoughPlayerHoursMsg',"‚ùå");
      return false;
    }

    playerHours -= neededPlayerHours;
    car.carHoursLeft -= hoursToDrive;
    let earnings = hoursToDrive * car.hourlyRate;
    cash += earnings;
    logMessage('driveCarMsg',"üöï",{hours: hoursToDrive, model:car.modelName, id:car.id, tsd:getTSDName(car.tsdLevel), earnings:earnings.toFixed(2)});
    updateUI();
    return true;
  }

  function addDriveListeners(tr, car){
    const driveBtn = tr.querySelector(`#fleet-driveCar-${car.id}`);
    const hoursInput = tr.querySelector(`#fleet-driveHours-${car.id}`);
    const hoursValueLabel = tr.querySelector(`#fleet-driveValue-${car.id}`);

    const maxHours = getMaxDriveHoursForCar(car);
    hoursInput.max = maxHours.toString();

    function updateValueLabel(){
      hoursValueLabel.textContent = hoursInput.value + "h";
    }

    hoursInput.addEventListener('input', updateValueLabel);

    driveBtn.addEventListener('click', () => {
      let hoursToDrive = parseInt(hoursInput.value) || 0;
      attemptDrive(car, hoursToDrive);
    });

    updateValueLabel();
  }

  function addTSDListeners(td, car) {
    const superviseSubBtn = td.querySelector(`.supervise-sub-${car.id}`);
    const superviseBuyBtn = td.querySelector(`.supervise-buy-${car.id}`);
    const unsuperviseSubBtn = td.querySelector(`.unsupervise-sub-${car.id}`);
    const unsuperviseBuyBtn = td.querySelector(`.unsupervise-buy-${car.id}`);
  
    function canSubscribeSupervised(){
      return car.tsdLevel===0 && !car.supervisedOwned && !car.supervisedSubscribed;
    }
    function canBuySupervised(){
      return car.tsdLevel===0 && !car.supervisedOwned && !car.supervisedSubscribed && cash>=CONFIG.buyoutCosts.supervised;
    }
    function canSubscribeUnsupervised(){
      return car.tsdLevel<2 && !car.unsupervisedOwned && !car.unsupervisedSubscribed && cars.length >= 2;
    }
    function canBuyUnsupervised(){
      return car.tsdLevel<2 && !car.unsupervisedOwned && !car.unsupervisedSubscribed && cash>=CONFIG.buyoutCosts.unsupervised && cars.length >= 2;
    }
  
    superviseSubBtn.disabled = !canSubscribeSupervised() || cash<CONFIG.subscriptionCosts.supervised;
    superviseBuyBtn.disabled = !canBuySupervised();
    unsuperviseSubBtn.disabled = !canSubscribeUnsupervised() || cash<CONFIG.subscriptionCosts.unsupervised;
    unsuperviseBuyBtn.disabled = !canBuyUnsupervised();
  
    superviseSubBtn.addEventListener('click', ()=>{
      if(canSubscribeSupervised() && cash>=CONFIG.subscriptionCosts.supervised){
        car.tsdLevel = 1;
        car.supervisedSubscribed = true;
        gtag('event', 'tsd_upgrade', {
          car_id: car.id,
          old_tsd: 'none',
          new_tsd: 'supervised',
          upgrade_type: 'subscription'
        });
        logMessage('subscribedSupMsg',"ü§ñ",{id:car.id});
        updateUI();
      } else {
        logMessage('cannotSubSupMsg',"‚ùå");
      }
    });
  
    superviseBuyBtn.addEventListener('click', ()=>{
      if(canBuySupervised()){
        cash -= CONFIG.buyoutCosts.supervised;
        car.tsdLevel = 1;
        car.supervisedOwned = true;
        car.supervisedSubscribed = false;
        gtag('event', 'tsd_upgrade', {
          car_id: car.id,
          old_tsd: 'none',
          new_tsd: 'supervised',
          upgrade_type: 'buyout',
          cost: CONFIG.buyoutCosts.supervised
        });
        logMessage('boughtSupMsg',"üí∞",{id:car.id});
        updateUI();
      } else {
        logMessage('cannotBuySupMsg',"‚ùå");
      }
    });
  
    unsuperviseSubBtn.addEventListener('click', ()=>{
      if(canSubscribeUnsupervised() && cash>=CONFIG.subscriptionCosts.unsupervised){
        car.tsdLevel = 2;
        car.unsupervisedSubscribed = true;
        car.supervisedSubscribed = false;
        car.supervisedOwned = false;
        logMessage('subscribedUnSupMsg',"ü§ñ",{id:car.id});
        updateUI();
      } else {
        logMessage('cannotSubUnSupMsg',"‚ùå");
      }
    });
  
    unsuperviseBuyBtn.addEventListener('click', ()=>{
      if(canBuyUnsupervised()){
        cash -= CONFIG.buyoutCosts.unsupervised;
        car.tsdLevel = 2;
        car.unsupervisedOwned = true;
        car.unsupervisedSubscribed = false;
        car.supervisedSubscribed = false;
        car.supervisedOwned = false;
        logMessage('boughtUnSupMsg',"üí∞",{id:car.id});
        updateUI();
      } else {
        logMessage('cannotBuyUnSupMsg',"‚ùå");
      }
    });
  
    if (car.supervisedOwned) {
      superviseSubBtn.classList.add('tsd-active');
      superviseBuyBtn.classList.add('tsd-active');
    } else if (car.supervisedSubscribed) {
      superviseSubBtn.classList.add('tsd-active');
      superviseBuyBtn.classList.remove('tsd-active');
    } else {
      superviseSubBtn.classList.remove('tsd-active');
      superviseBuyBtn.classList.remove('tsd-active');
    }

    if (car.unsupervisedOwned) {
      unsuperviseSubBtn.classList.add('tsd-active');
      unsuperviseBuyBtn.classList.add('tsd-active');
    } else if (car.unsupervisedSubscribed) {
      unsuperviseSubBtn.classList.add('tsd-active');
      unsuperviseBuyBtn.classList.remove('tsd-active');
    } else {
      unsuperviseSubBtn.classList.remove('tsd-active');
      unsuperviseBuyBtn.classList.remove('tsd-active');
    }
  }

  function addSellListener(td, car){
    const sellBtn = td.querySelector(`.sell-car-button[data-car-id="${car.id}"]`);
    sellBtn.addEventListener('click', ()=>{
      let carCost = getCarCost(car);
      let tsdBuyout = getTsdBuyoutCost(car);
      let total = carCost + tsdBuyout;
      let salePrice = total * 0.6;
      let msg = getLocalizedMsg('sellConfirmMsg',{
        model:car.modelName,
        id:car.id,
        carCost:carCost.toFixed(2),
        tsdBuyout:tsdBuyout.toFixed(2),
        total:total.toFixed(2),
        salePrice:salePrice.toFixed(2)
      });
      if(confirm(msg)){
        cash += salePrice;
        cars = cars.filter(c=>c.id!==car.id);
        updateUI();
      }
    });
  }

  function getCarCost(car){
    let model = CONFIG.fleetModels.find(m=>m.name===car.modelName);
    return model.cost;
  }

  function getTsdBuyoutCost(car){
    if(car.unsupervisedOwned) return CONFIG.buyoutCosts.unsupervised;
    if(car.supervisedOwned) return CONFIG.buyoutCosts.supervised;
    return 0;
  }

  function renderCarRow(car){
    const tsdName = getTSDName(car.tsdLevel);
    const subSupText = getLocalizedMsg('subSupBtn');
    const buySupText = getLocalizedMsg('buySupBtn');
    const subUnSupText = getLocalizedMsg('subUnSupBtn');
    const buyUnSupText = getLocalizedMsg('buyUnSupBtn');

    let idDisplay = `#${car.id}`;
    if(car.financed && car.daysPaid < car.loanTermDays) {
      idDisplay += ` (${car.daysPaid}/${car.loanTermDays})`;
    }

    return `
      <tr>
        <td>${idDisplay}</td>
        <td>${car.modelName}</td>
        <td>$${car.hourlyRate.toFixed(2)}/hr</td>
        <td>${tsdName}</td>
        <td>${car.carHoursLeft}h</td>
        <td>
          <input type="range" min="0" max="${car.carHoursLeft}" value="${car.carHoursLeft}" step="1" id="fleet-driveHours-${car.id}">
          <span id="fleet-driveValue-${car.id}">0h</span>
        </td>
        <td>
          <div class="car-actions">
            <button id="fleet-driveCar-${car.id}">${getLocalizedMsg('tableDriveAction')}</button>
            <button class="sell-car-button" data-car-id="${car.id}" data-i18n="tableSell">${getLocalizedMsg('tableSell')}</button>
          </div>
        </td>
        <td>
          <div class="tsd-actions">
            <div class="tsd-action-row">
              <button class="supervise-sub-${car.id}">${subSupText}</button>
              <button class="supervise-buy-${car.id}">${buySupText}</button>
            </div>
            <div class="tsd-action-row">
              <button class="unsupervise-sub-${car.id}">${subUnSupText}</button>
              <button class="unsupervise-buy-${car.id}">${buyUnSupText}</button>
            </div>
          </div>
        </td>
      </tr>
    `;
  }

  function renderCarList(){
    carListBody.innerHTML = '';
    cars.forEach(car => {
      const html = renderCarRow(car);
      const temp = document.createElement('tbody');
      temp.innerHTML = html;
      const tr = temp.querySelector('tr');
      carListBody.appendChild(tr);
      addDriveListeners(tr, car);
      const tsdTd = tr.querySelectorAll('td')[7];
      addTSDListeners(tsdTd, car);
      const sellTd = tr.querySelectorAll('td')[6];
      addSellListener(sellTd, car);
    });
  }

  function amortizationDailyPayment(principal, annualInterestRate, termDays){
    const r = annualInterestRate / 365; 
    const pow = Math.pow((1+r), termDays);
    const numerator = r * pow;
    const denominator = pow - 1;
    if(denominator === 0) return principal / termDays;
    return principal*(numerator/denominator);
  }

  function triggerUnexpectedExpenses(){
    let totalCost = 0;

    // Personal expense
    if(Math.random() < CONFIG.personalExpenseChance) {
        let baseCost = randRange(CONFIG.personalBaseRange[0], CONFIG.personalBaseRange[1]);
        let scaleFactor = 1 + Math.log10(Math.max(1,cars.length)) * 0.5;
        let personalCost = Math.round(baseCost * scaleFactor);
        
        const reasons = LANG_STRINGS[currentLang].personalReasons;
        const reason = reasons[
            Math.floor(Math.random() * reasons.length)
        ];
        
        logMessage('personalExpenseMsg', "üí∏", {
          reason: reason,
          cost: personalCost.toFixed(2)
        });
        totalCost += personalCost;
    }

    // Business expense
    let totalBusinessCost = 0;
    let affectedCars = 0;
    
    cars.forEach(car => {
      let carChance = 0.2;
      if (car.tsdLevel === 1) carChance = 0.05; 
      if (car.tsdLevel === 2) carChance = 0.01; 
      
      if (Math.random() < carChance) {
        let baseCost = randRange(CONFIG.businessBaseRange[0], CONFIG.businessBaseRange[1]);
        totalBusinessCost += Math.round(baseCost);
        affectedCars++;
      }
    });
    
    if (totalBusinessCost > 0) {
      const reasons = LANG_STRINGS[currentLang].businessReasons;
      const reason = reasons[
          Math.floor(Math.random() * reasons.length)
      ];

      if(currentInsurance) {
          const ins = CONFIG.insuranceOptions[currentInsurance];
          if(Math.random() < ins.rejectionRate) {
              logMessage('businessExpenseMsg', "üí•", {
                cars: affectedCars,
                reason: reason,
                insurance: LANG_STRINGS[currentLang][`insurance${currentInsurance}`],
                status: getLocalizedMsg('insuranceRejected', {cost: totalBusinessCost.toFixed(2)})
              });
              totalCost += totalBusinessCost;
          } else {
              let deductibleCost = Math.round(totalBusinessCost * CONFIG.insuranceDeductible);
              logMessage('businessExpenseMsg', "ü©∫", {
                cars: affectedCars,
                reason: reason,
                insurance: LANG_STRINGS[currentLang][`insurance${currentInsurance}`],
                status: getLocalizedMsg('insuranceApproved', {
                  covered: (totalBusinessCost - deductibleCost).toFixed(2),
                  deductible: deductibleCost.toFixed(2)
                })
              });
              totalCost += deductibleCost;
          }
      } else {
          logMessage('businessNoInsuranceMsg', "üî•", {
            cars: affectedCars,
            reason: reason,
            cost: totalBusinessCost.toFixed(2)
          });
          totalCost += totalBusinessCost;
      }
    }

    return totalCost;
  }

  function randRange(min, max){
    return Math.random()*(max-min)+min;
  }

  endDayBtn.addEventListener('click', function(){
    const hasIdleUnsupervisedTaxis = cars.some(car => 
      car.tsdLevel === 2 && car.carHoursLeft > 0
    );

    if (hasIdleUnsupervisedTaxis) {
      const confirmMsg = currentLang === 'cn' 
        ? "ÊÇ®ËøòÊúâÊú™‰ΩøÁî®ÁöÑÊó†‰∫∫È©æÈ©∂Âá∫ÁßüËΩ¶„ÄÇÁ°ÆÂÆöË¶ÅÁªìÊùü‰ªäÂ§©ÂêóÔºü"
        : "You have unused unsupervised taxis. Are you sure you want to end the day?";
      if (!confirm(confirmMsg)) {
        return;
      }
    }

    let unexpectedCost = triggerUnexpectedExpenses();
    cash -= unexpectedCost;

    let expense = getTotalDailyExpense();
    cash -= expense;

    let dailyCashFlow = cash - previousCash;
    previousCash = cash; 

    cashflowData.labels.push('Day ' + (day + 1));
    cashflowData.datasets[0].data.push(dailyCashFlow);
    trimChartData();
    cashflowChart.update();

    cars.forEach(car=>{
      if(car.financed && car.daysPaid < car.loanTermDays) {
        car.daysPaid++;
        if(car.daysPaid >= car.loanTermDays) {
          car.dailyPayment = 0;
        }
      }
    });

    if(cash < 0) {
      logMessage('brokeMsg',"üíÄ");
      gameOverMsg.style.display = 'block';
      disableAllActions();
      return;
    }

    day++;
    playerHours = CONFIG.playerDailyHours;
    cars.forEach(car => {
      car.carHoursLeft = CONFIG.carDailyHours;
    });

    gtag('event', 'end_day', {
      day: day,
      remaining_cash: cash,
      cars_owned: cars.length,
      daily_cashflow: dailyCashFlow
    });

    logMessage('dayEndedMsg',"üìÖ",{cash:cash.toFixed(2), day:day});
    updateUI();
  });

  function updateDriveUnsupervisedButton(){
    const hasUnsupervisedCar = cars.some(car=>car.tsdLevel===2);
    driveUnsupervisedBtn.style.display = hasUnsupervisedCar ? 'inline-block' : 'none';
  }

  driveUnsupervisedBtn.addEventListener('click', ()=>{
    let totalEarnings = 0;
    let carsOperated = 0;

    cars.forEach(car=>{
        if(car.tsdLevel>=1 && car.carHoursLeft>0){
            let hoursToDrive = car.carHoursLeft;
            if(car.tsdLevel===2){
                let earnings = hoursToDrive * car.hourlyRate;
                car.carHoursLeft = 0;
                totalEarnings += earnings;
                carsOperated++;
                cash += earnings;
            } else if(car.tsdLevel===1) {
                let neededPH = getPlayerHourConsumption(1, hoursToDrive);
                if(neededPH > playerHours){
                    let maxH = Math.floor(playerHours * 2);
                    let driveH = Math.min(hoursToDrive, maxH);
                    if(driveH > 0){
                        let earnings = driveH * car.hourlyRate;
                        car.carHoursLeft -= driveH;
                        playerHours -= getPlayerHourConsumption(1, driveH);
                        totalEarnings += earnings;
                        carsOperated++;
                        cash += earnings;
                    }
                } else {
                    let earnings = hoursToDrive * car.hourlyRate;
                    car.carHoursLeft = 0;
                    playerHours -= neededPH;
                    totalEarnings += earnings;
                    carsOperated++;
                    cash += earnings;
                }
            }
        }
    });

    if(carsOperated > 0) {
        logMessage(`Fleet operation complete! ${carsOperated} cars earned $${totalEarnings.toFixed(2)}`, "üöï");
    }
    
    updateUI();
  });

  function updateFinanceDisplay() {
    const model = getSelectedModel();
    if(model) {
      const minDownPayment = model.cost * 0.3; 
      downPaymentRange.min = minDownPayment;  
      downPaymentRange.max = model.cost;
      
      let downPayment = Math.max(minDownPayment, parseFloat(downPaymentRange.value) || 0);
      downPaymentRange.value = downPayment;
      let termDays = parseInt(loanTermRange.value);

      let financed = Math.max(0, model.cost - downPayment);
      let dailyPayment = 0;
      if(financed > 0 && termDays>0) {
        dailyPayment = amortizationDailyPayment(financed, CONFIG.apr, termDays);
      }

      dailyCostDisplay.textContent = "$" + dailyPayment.toFixed(2);
      let hourlyRate = (model.dailyIncome / CONFIG.carDailyHours);
      dailyEarningDisplay.textContent = "$" + hourlyRate.toFixed(2);
      fullPriceDisplay.textContent = "$" + model.cost.toFixed(2);
      downPaymentValue.textContent = downPayment.toFixed(2);
    } else {
      downPaymentRange.value = 0;
      downPaymentValue.textContent = "0";
      fullPriceDisplay.textContent = "$0";
      dailyCostDisplay.textContent = "$0";
      dailyEarningDisplay.textContent = "$0";
    }
  }

  downPaymentRange.addEventListener('input', function(){
    updateFinanceDisplay();
  });

  loanTermRange.addEventListener('input', function(){
    loanTermValue.textContent = loanTermRange.value;
    updateFinanceDisplay();
  });

  buyFleetBtn.addEventListener('click', function(){
    if(cash < 0) {
      logMessage('brokeBuyMsg',"‚ùå");
      return;
    }
    const model = getSelectedModel();
    if(!model) {
      logMessage('noModelSelectedMsg',"‚ùå");
      return;
    }

    let downPayment = parseFloat(downPaymentRange.value) || 0;
    const minDownPayment = model.cost * 0.3; 
    
    if(downPayment < minDownPayment) {
      logMessage('minDownPaymentMsg',"‚ùå");
      return;
    }

    let termDays = parseInt(loanTermRange.value);
    if(downPayment > cash) {
      logMessage('noCashForDownMsg',"‚ùå");
      return;
    }

    let financed = Math.max(0, model.cost - downPayment);
    let dailyPayment = 0;
    if(financed > 0 && termDays>0) {
      dailyPayment = amortizationDailyPayment(financed, CONFIG.apr, termDays);
    }

    cash -= downPayment;

    const hourlyRate = model.dailyIncome / CONFIG.carDailyHours;
    const newCarId = nextCarId++;
    cars.push({
      id: newCarId,
      modelName: model.name,
      hourlyRate: hourlyRate,
      carHoursLeft: CONFIG.carDailyHours,
      tsdLevel: 0,
      supervisedSubscribed: false,
      supervisedOwned: false,
      unsupervisedSubscribed: false,
      unsupervisedOwned: false,
      financed: financed > 0,
      dailyPayment: dailyPayment,
      loanTermDays: termDays,
      daysPaid: 0
    });

    gtag('event', 'purchase_car', {
      model: model.name,
      cost: model.cost,
      down_payment: downPayment,
      term_days: termDays
    });

    logMessage('purchasedCarMsg',"üöò",{model:model.name,id:newCarId,down:downPayment.toFixed(2),daily:dailyPayment.toFixed(2),term:termDays});
    updateUI();
  });

  function disableAllActions(){
    gtag('event', 'game_over', {
      final_day: day,
      final_cash: cash,
      cars_owned: cars.length
    });

    endDayBtn.disabled = true;
    buyFleetBtn.disabled = true;
    fleetModelSelect.disabled = true;
    downPaymentRange.disabled = true;
    loanTermRange.disabled = true;
    driveUnsupervisedBtn.disabled = true;
    document.querySelectorAll('button').forEach(btn=>{
      if (btn.id !== 'resetBtn') {
        btn.disabled = true;
      }
    });
  }

  CONFIG.fleetModels.forEach((m,i) => {
    let opt = document.createElement('option');
    opt.value = i;
    opt.textContent = m.name;
    fleetModelSelect.appendChild(opt);
  });

  fleetModelSelect.addEventListener('change', function(){
    updateFinanceDisplay();
  });

  document.querySelectorAll('input[name="insurance"]').forEach(radio => {
    radio.addEventListener('change', () => {
      currentInsurance = radio.value;
      const displayEl = document.getElementById('currentInsuranceDisplay');
      
      if (currentInsurance === 'None') {
        displayEl.setAttribute('data-i18n', 'currentInsuranceNone');
        displayEl.textContent = LANG_STRINGS[currentLang].currentInsuranceNone;
      } else {
        displayEl.removeAttribute('data-i18n');
        displayEl.textContent = LANG_STRINGS[currentLang][`insurance${currentInsurance}`];
      }
      
      const container = displayEl.closest('.current-insurance');
      container.classList.remove('geckgo', 'progresso', 'allstat', 'lemonaid', 'selected');
      if (currentInsurance !== 'None') {
        container.classList.add(currentInsurance.toLowerCase(), 'selected');
      }
      
      updateUI();
      saveState(); 
    });
  });

  if (currentInsurance) {
    const displayEl = document.getElementById('currentInsuranceDisplay');
    const container = displayEl.closest('.current-insurance');
    
    if (currentInsurance === 'None') {
      displayEl.setAttribute('data-i18n', 'currentInsuranceNone');
      displayEl.textContent = LANG_STRINGS[currentLang].currentInsuranceNone;
    } else {
      displayEl.removeAttribute('data-i18n');
      displayEl.textContent = LANG_STRINGS[currentLang][`insurance${currentInsurance}`];
      container.classList.add(currentInsurance.toLowerCase(), 'selected');
    }
  }

  if(cars.length===0) {
    (function startWithTypeY(){
      let model = CONFIG.fleetModels.find(m=>m.name==="Type Y");
      let hourlyRate = model.dailyIncome / CONFIG.carDailyHours;
      cars.push({
        id: nextCarId++,
        modelName: model.name,
        hourlyRate: hourlyRate,
        carHoursLeft: CONFIG.carDailyHours,
        tsdLevel: 0,
        supervisedSubscribed: false,
        supervisedOwned: false,
        unsupervisedSubscribed: false,
        unsupervisedOwned: false,
        financed: false,
        dailyPayment:0,
        loanTermDays:0,
        daysPaid:0
      });
      updateUI();
      logMessage('startCarMsg',"üéâ");
    })();
  } else {
    updateUI();
    renderLogs();
  }

  langToggle.addEventListener('click', () => {
    langToggle.classList.toggle('active');
    currentLang = langToggle.classList.contains('active') ? 'cn' : 'en';
    gtag('event', 'language_change', {
      language: currentLang
    });
    translateUI();
    updateUI();
    renderLogs();
    updateChartTitle();
  });

  resetBtn.addEventListener('click', () => {
    const message = currentLang === 'cn' 
      ? "ÊÇ®Á°ÆÂÆöË¶ÅÈáçÁΩÆÂêóÔºüËøôÂ∞ÜÂà†Èô§ÊâÄÊúâËøõÂ∫¶„ÄÇ"
      : "Are you sure you want to reset? This will erase all your progress.";
    if (confirm(message)) {
      localStorage.clear();
      location.reload();
    }
  });

  function updateChartTitle() {
    cashflowChart.options.plugins.title.text = LANG_STRINGS[currentLang].chartTitle;
    cashflowChart.update();
  }

  translateUI();
  updateFinanceDisplay();
  if(logs.length===0) {
    logMessage('welcomeChallenge',"üëã");
  }

  function updateInsuranceCards() {
    document.querySelectorAll('.insurance-card').forEach(card => {
      const insuranceName = card.querySelector('input[name="insurance"]').value;
      const option = CONFIG.insuranceOptions[insuranceName];

      if (option) {
        const rates = card.querySelectorAll('.rate-value');
        rates[0].textContent = `$${option.costs[0].toFixed(2)}/car-day`;
        rates[1].textContent = `$${option.costs[1].toFixed(2)}/car-day`;
        rates[2].textContent = `$${option.costs[2].toFixed(2)}/car-day`;
      }
    });
  }

  // Call this function after the DOM is fully loaded or whenever the language changes
  document.addEventListener('DOMContentLoaded', () => {
    updateInsuranceCards();
  });

})();
</script>
</body>
</html>
