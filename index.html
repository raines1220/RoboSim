<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Robotaxi Simulator - Totally Self-Driving</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWK987RB6M"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-YWK987RB6M');
  </script>
</head>
<body>
<header>
  <h1>
    <svg viewBox="0 0 24 24" fill="currentColor">
      <path d="M21,11l-2-7H5L3,11H2c0,0.5,0.4,1,1,1h1l-0.3,1.1C3.3,13.4,3,13.9,3,14.5V20c0,0.6,0.4,1,1,1h1
        c0.6,0,1-0.4,1-1v-1h12v1c0,0.6,0.4,1,1,1h1c0.6,0,1-0.4,1-1v-5.5c0-0.6-0.3-1.1-0.7-1.4L20,12h1c0.6,0,1-0.5,1-1H21z M6.8,6h10.4
        l1.4,5H5.4L6.8,6z M7,16c-0.8,0-1.5-0.7-1.5-1.5S6.2,13,7,13s1.5,0.7,1.5,1.5S7.8,16,7,16z M17,16c-0.8,0-1.5-0.7-1.5-1.5
        S16.2,13,17,13s1.5,0.7,1.5,1.5S17.8,16,17,16z"/>
      <path d="M9,8.5h6c0.3,0,0.5-0.2,0.5-0.5S15.3,7.5,15,7.5H9C8.7,7.5,8.5,7.7,8.5,8S8.7,8.5,9,8.5z"/>
    </svg>
    <span data-i18n="appTitle">Robotaxi Simulator - Totally Self-Driving</span>
  </h1>
  <div class="lang-toggle-container">
    <span class="lang-label">EN</span>
    <div class="lang-toggle" id="langToggle"></div>
    <span class="lang-label">CN</span>
    <button id="resetBtn" style="margin-left:10px; background:#ff6b6b;">Reset</button>
  </div>
</header>

<main>
  <div id="gameOverMsg" data-i18n="gameOverMsg">Game Over! You went broke. Refresh to start over.</div>

  <div class="dashboard-container">
    <div class="log-bar-container">
      <div id="log"></div>
    </div>
    <div class="chart-container">
      <canvas id="cashflowChart"></canvas>
    </div>
  </div>

  <div class="stats-cards">
    <div class="stat-card">
      <h3 data-i18n="dayLabel">Day</h3>
      <div class="stat-value" id="day">1</div>
    </div>
    <div class="stat-card">
      <h3 data-i18n="cashLabel">Cash</h3>
      <div class="stat-value" id="cash">0</div>
    </div>
    <div class="stat-card">
      <h3 data-i18n="dailyExpenseLabel">Daily Expense</h3>
      <div class="stat-value" id="dailyExpense">100</div>
    </div>
    <div class="stat-card">
      <h3 data-i18n="playerHoursLabel">Player Hours Left</h3>
      <div class="stat-value" id="playerHours">8</div>
    </div>
    <div class="stat-card">
      <h3 data-i18n="carsOwnedLabel">Cars Owned</h3>
      <div class="stat-value" id="numCars">0</div>
    </div>
  </div>

  <div class="panels-container">
    <div class="panel">
      <div class="cars-header">
        <div class="section-title" data-i18n="yourCars">Your Cars</div>
        <div class="cars-header-buttons">
          <button id="driveUnsupervisedBtn" style="display:none;" data-i18n="driveUnsupervisedBtn">Drive Unsupervised Fleet</button>
          <button id="endDayBtn" data-i18n="endDayBtn">‚è≠ End Day</button>
        </div>
      </div>
      <div class="table-container">
        <table id="car-list">
          <thead>
            <tr>
              <th data-i18n="tableID">ID</th>
              <th data-i18n="tableCar">Car</th>
              <th data-i18n="tableHourRate">$/hr</th>
              <th data-i18n="tableTSD">TSD</th>
              <th data-i18n="tableCarHours">Car H</th>
              <th data-i18n="tableDriveHours">Drive H</th>
              <th data-i18n="tableCarActions">Car Actions</th>
              <th data-i18n="tableTSDActions">TSD Actions</th>
            </tr>
          </thead>
          <tbody id="car-list-body"></tbody>
        </table>
        
      </div>
    </div>

    <div class="panel">
      <div class="purchase-header">
        <div class="section-title" data-i18n="buyMoreCars">Buy More Cars</div>
      </div>
      <div class="merged-row">
        <div class="purchase-row-item">
          <label data-i18n="selectModel">Select Model:</label>
          <select id="fleetModelSelect"></select>
        </div>
        <div class="purchase-row-item">
          <label data-i18n="downPayment">Down Payment:</label>
          <input type="range" id="downPaymentRange" min="0" value="0" step="100" data-i18n="downPayment">
          $<span id="downPaymentValue">0</span>
        </div>
        <div class="purchase-row-item">
          <label data-i18n="loanTerm">Loan Term (Days):</label>
          <input type="range" id="loanTermRange" min="30" max="120" value="30" step="1" data-i18n="loanTerm">
          <span id="loanTermValue">30</span> days
        </div>
      </div>
      
      <div class="merged-row">
        <div class="purchase-row-item">
          <label data-i18n="fullPrice">Full Price:</label> 
          <span id="fullPriceDisplay">$0</span>
        </div>
        <div class="purchase-row-item">
          <label data-i18n="hourlyEarning">Est. Hourly Earning:</label> 
          <span id="dailyEarningDisplay">$0</span>
        </div>
        <div class="purchase-row-item">
          <label data-i18n="dailyCost">Daily Cost (APR 120%):</label> 
          <span id="dailyCostDisplay">$0</span>
        </div>
      </div>
      
      <div class="purchase-action">
        <button id="buyFleetBtn" data-i18n="buySelectedModel">Buy Selected Model</button>
      </div>
    </div>

    <div class="panel">
      <div class="section-title" data-i18n="instructionsTitle">Instructions & TSD Info</div>
      <div class="instructions-grid">
        <div class="instruction-card">
          <div class="instruction-icon">üöó</div>
          <h4 data-i18n="noTSDTitle">No TSD</h4>
          <p data-i18n="noTSDDesc">1h drive = 1h player time</p>
        </div>
        <div class="instruction-card">
          <div class="instruction-icon">üëÄ</div>
          <h4 data-i18n="supervisedTitle">TSD (Supervised)</h4>
          <p data-i18n="supervisedDesc">1h drive = 0.5h player time</p>
        </div>
        <div class="instruction-card">
          <div class="instruction-icon">ü§ñ</div>
          <h4 data-i18n="unsupervisedTitle">TSD (Unsupervised)</h4>
          <p data-i18n="unsupervisedDesc">1h drive = 0h player time</p>
        </div>
        <div class="instruction-card">
          <div class="instruction-icon">üîì</div>
          <h4 data-i18n="unlockTitle">Unlock Requirements</h4>
          <p data-i18n="unlockDesc">Unsupervised TSD requires owning at least 2 cars</p>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
(function(){

  const LANG_STRINGS = {
    en: {
      appTitle: "Robotaxi Simulator - Totally Self-Driving",
      gameOverMsg: "Game Over! You went broke. Refresh to start over.",
      dayLabel: "Date",
      cashLabel: "Cash:",
      dailyExpenseLabel: "Daily Expense:",
      playerHoursLabel: "Player Hours Left:",
      carsOwnedLabel: "Cars Owned:",
      paymentCycle: "Financing is paid daily. Once fully paid off, daily expense reduces.",
      endDayBtn: "‚è≠ End Day",
      yourCars: "Your Cars",
      tableID: "ID",
      tableCar: "Car",
      tableHourRate: "$/hr",
      tableTSD: "TSD",
      tableCarHours: "Car H",
      tableDriveHours: "Drive H",
      tableDriveAction: "Drive",
      tableCarActions: "Car Actions",
      tableTSDActions: "TSD Actions",
      tableSell: "Sell",
      instructionsTitle: "Instructions & TSD Info",
      instructionsDesc: "Each car can have its own TSD level:",
      noTSD: "No TSD:",
      noTSDDesc: "1h drive = 1h player time",
      supervisedTSD: "TSD (Supervised):",
      supervisedTSDDesc: "1h drive = 0.5h player time (round up)",
      unsupervisedTSD: "TSD (Unsupervised):",
      unsupervisedTSDDesc: "1h drive = 0h player time",
      costsPerCar: "Costs per car for TSD upgrades:",
      supervisedCost: "Supervised: Subscribe($3.33/day) or Buyout($8000)",
      unsupervisedCost: "Unsupervised: Subscribe($10/day) or Buyout($24000)",
      noReq: "No requirement to have Supervised before Unsupervised. Manage your cars wisely and try not to go broke!",
      buyMoreCars: "Buy More Cars",
      selectModel: "Select Model:",
      fullPrice: "Full Price:",
      downPayment: "Down Payment:",
      loanTerm: "Loan Term (Days):",
      dailyCost: "Daily Cost (APR 120%):",
      hourlyEarning: "Est. Hourly Earning:",
      buySelectedModel: "Buy Selected Model",
      tsdNone: "None",
      tsdSupervised: "Supervised",
      tsdUnsupervised: "Unsupervised",

      subSupBtn: "Sub Sup(3.33/d)",
      buySupBtn: "Buy Sup($8000)",
      subUnSupBtn: "Sub UnSup($10/d)",
      buyUnSupBtn: "Buy UnSup($24000)",

      welcomeMsg: "Welcome to Robotaxi Simulator! üöÄ Manage your TSD per car and buy more cars!",
      startCarMsg: "You start with a free Type Y taxi!",
      invalidHoursMsg: "Invalid number of hours.",
      notEnoughPlayerHoursMsg: "Not enough player hours left.",
      driveCarMsg: "Drove {hours}h with {model} (#{id}, {tsd}), earned ${earnings}",
      monthlyFeeMsg: "Subscription fees of ${amount} charged.",
      brokeMsg: "You went broke! Game Over.",
      dayEndedMsg: "Day ended. After expenses, you have ${cash}. Moving to Day {day}.",
      subscribedSupMsg: "Car #{id}: TSD (Supervised) subscribed! ($3.33/day)",
      boughtSupMsg: "Car #{id}: TSD (Supervised) bought out ($8000)!",
      subscribedUnSupMsg: "Car #{id}: TSD (Unsupervised) subscribed! ($10/day)",
      boughtUnSupMsg: "Car #{id}: TSD (Unsupervised) bought out ($24000)!",
      cannotSubSupMsg: "Cannot subscribe TSD (Supervised) for this car.",
      cannotBuySupMsg: "Cannot buy TSD (Supervised) for this car.",
      cannotSubUnSupMsg: "Cannot subscribe TSD (Unsupervised) for this car.",
      cannotBuyUnSupMsg: "Cannot buy TSD (Unsupervised) for this car.",
      noModelSelectedMsg: "No model selected.",
      noCashForDownMsg: "Not enough cash for down payment.",
      brokeBuyMsg: "You are broke and cannot buy cars.",
      purchasedCarMsg: "You purchased a {model}(#{id}) for a down payment of ${down}. Daily cost: ${daily} for {term} days.",
      sellConfirmMsg: "Sell {model}(#{id})?\nCar cost: ${carCost}\nTSD Buyout: ${tsdBuyout}\nTotal: ${total}\nSale price: ${salePrice}\nConfirm?",
      driveUnsupervisedBtn: "Drive Unsupervised Fleet",
      noTSDTitle: "No TSD",
      noTSDDesc: "1h drive = 1h player time",
      supervisedTitle: "TSD (Supervised)",
      supervisedDesc: "1h drive = 0.5h player time",
      unsupervisedTitle: "TSD (Unsupervised)",
      unsupervisedDesc: "1h drive = 0h player time",
      unlockTitle: "Unlock Requirements",
      unlockDesc: "Unsupervised TSD requires owning at least 2 cars",
      dayTemplate: "Day {day}",
      chartTitle: "Daily Cash Flow",
      minDownPaymentMsg: "Minimum down payment is 30% of the car price.",
    },
    cn: {
      appTitle: "Êú∫Âô®‰∫∫Âá∫ÁßüËΩ¶Ê®°ÊãüÂô® - ÂÖ®Ëá™Âä®È©æÈ©∂",
      gameOverMsg: "Ê∏∏ÊàèÁªìÊùüÔºÅ‰Ω†Á†¥‰∫ß‰∫Ü„ÄÇÂà∑Êñ∞È°µÈù¢ÈáçÊñ∞ÂºÄÂßã„ÄÇ",
      dayLabel: "ÂΩìÂâçÂ§©Êï∞",
      cashLabel: "ÂΩìÂâçÁé∞Èáë:",
      dailyExpenseLabel: "ÊØèÊó•ÊîØÂá∫:",
      playerHoursLabel: "ÂèØÁî®Â∑•‰ΩúÊó∂Èó¥:",
      carsOwnedLabel: "ËΩ¶ÈòüËßÑÊ®°:",
      paymentCycle: "Ë¥∑Ê¨æÊØèÊó•ÊîØ‰ªò„ÄÇËøòÊ∏ÖÂêéÔºåÊØèÊó•ÂºÄÈîÄÈôç‰Ωé„ÄÇ",
      endDayBtn: "‚è≠ ÁªìÊùü‰∏ÄÂ§©",
      yourCars: "‰Ω†ÁöÑËΩ¶ËæÜ",
      tableID: "ÁºñÂè∑",
      tableCar: "ËΩ¶ËæÜ",
      tableHourRate: "$/Â∞èÊó∂",
      tableTSD: "TSD",
      tableCarHours: "ËΩ¶ËæÜÂ∞èÊó∂",
      tableDriveHours: "È©æÈ©∂Â∞èÊó∂",
      tableDriveAction: "È©æÈ©∂",
      tableCarActions: "ËΩ¶ËæÜÊìç‰Ωú",
      tableTSDActions: "TSDÊìç‰Ωú",
      tableSell: "Âá∫ÂîÆ",
      instructionsTitle: "ËØ¥Êòé & ÂÖ®Ëá™Âä®È©æÈ©∂‰ø°ÊÅØ",
      instructionsDesc: "ÊØèËæÜËΩ¶ÈÉΩÊúâÂÖ∂ÂÖ®Ëá™Âä®È©æÈ©∂(TSD)Á∫ßÂà´Ôºö",
      noTSD: "Êó†TSD:",
      noTSDDesc: "1Â∞èÊó∂È©æÈ©∂=1Â∞èÊó∂Áé©ÂÆ∂Êó∂Èó¥",
      supervisedTSD: "ÊúâÁõëÁù£TSD:",
      supervisedTSDDesc: "1Â∞èÊó∂È©æÈ©∂=0.5Â∞èÊó∂Áé©ÂÆ∂Êó∂Èó¥(Âêë‰∏äÂèñÊï¥)",
      unsupervisedTSD: "Êó†ÁõëÁù£TSD:",
      unsupervisedTSDDesc: "1Â∞èÊó∂È©æÈ©∂=0Â∞èÊó∂Áé©ÂÆ∂Êó∂Èó¥",
      costsPerCar: "ÊØèËæÜËΩ¶ÁöÑÂÖ®Ëá™Âä®È©æÈ©∂ÂçáÁ∫ßÊàêÊú¨:",
      supervisedCost: "ÊúâÁõëÁù£: ËÆ¢ÈòÖ($3.33/Â§©)Êàñ‰π∞Êñ≠($8000)",
      unsupervisedCost: "Êó†ÁõëÁù£: ËÆ¢ÈòÖ($10/Â§©)Êàñ‰π∞Êñ≠($24000)",
      noReq: "Êó†ÈúÄÂÖàÊúâÁõëÁù£ÂêéÊó†ÁõëÁù£„ÄÇÊòéÊô∫ÁÆ°ÁêÜ‰Ω†ÁöÑËΩ¶ËæÜÔºåÈÅøÂÖçÁ†¥‰∫ßÔºÅ",
      buyMoreCars: "Ë¥≠‰π∞Êõ¥Â§öËΩ¶ËæÜ",
      selectModel: "ÈÄâÊã©ËΩ¶Âûã:",
      fullPrice: "ÂÖ®È¢ù‰ª∑Ê†º:",
      downPayment: "È¶ñ‰ªò:",
      loanTerm: "Ë¥∑Ê¨æÊúüÈôêÔºàÂ§©Ôºâ:",
      dailyCost: "ÊØèÊó•Ë¥πÁî®ÔºàAPR 120%Ôºâ:",
      hourlyEarning: "È¢ÑËÆ°Êó∂Êî∂ÂÖ•:",
      buySelectedModel: "Ë¥≠‰π∞ÊâÄÈÄâËΩ¶Âûã",
      tsdNone: "Êó†",
      tsdSupervised: "ÊúâÁõëÁù£",
      tsdUnsupervised: "Êó†ÁõëÁù£",

      subSupBtn: "ËÆ¢ÊúâÁõë($3.33/Â§©)",
      buySupBtn: "‰π∞ÊúâÁõë($8000)",
      subUnSupBtn: "ËÆ¢Êó†Áõë($10/Â§©)",
      buyUnSupBtn: "‰π∞Êó†Áõë($24000)",

      welcomeMsg: "Ê¨¢ËøéÊù•Âà∞Êú∫Âô®‰∫∫Âá∫ÁßüËΩ¶Ê®°ÊãüÂô®ÔºÅüöÄ ‰∏∫ÊØèËæÜËΩ¶ÁÆ°ÁêÜÂÖ®Ëá™Âä®È©æÈ©∂Âπ∂Ë¥≠‰π∞Êõ¥Â§öËΩ¶ËæÜÔºÅ",
      startCarMsg: "‰Ω†‰ªé‰∏ÄËæÜÂÖçË¥πÁöÑType YÂá∫ÁßüËΩ¶ÂºÄÂßãÔºÅ",
      invalidHoursMsg: "Êó†ÊïàÁöÑÈ©æÈ©∂Â∞èÊó∂Êï∞„ÄÇ",
      notEnoughPlayerHoursMsg: "Áé©ÂÆ∂Â∑•Êó∂‰∏çË∂≥„ÄÇ",
      driveCarMsg: "‰ΩøÁî®{model}(#{id}, {tsd})È©æÈ©∂{hours}Â∞èÊó∂ÔºåËµöÂèñ${earnings}",
      monthlyFeeMsg: "ËÆ¢ÈòÖË¥πÁî®${amount}Â∑≤Êâ£Èô§„ÄÇ",
      brokeMsg: "‰Ω†Á†¥‰∫ß‰∫ÜÔºÅÊ∏∏ÊàèÁªìÊùü„ÄÇ",
      dayEndedMsg: "‰∏ÄÂ§©ÁªìÊùü„ÄÇÊâ£Èô§Ë¥πÁî®ÂêéÔºå‰Ω†ËøòÊúâ${cash}„ÄÇËøõÂÖ•Á¨¨{day}Â§©„ÄÇ",
      subscribedSupMsg: "ËΩ¶ËæÜ#{id}: Â∑≤ËÆ¢ÈòÖÊúâÁõëÁù£TSD ($3.33/Â§©)",
      boughtSupMsg: "ËΩ¶ËæÜ#{id}: Â∑≤‰π∞Êñ≠ÊúâÁõëÁù£TSD($8000)!",
      subscribedUnSupMsg: "ËΩ¶ËæÜ#{id}: Â∑≤ËÆ¢ÈòÖÊó†ÁõëÁù£TSD ($10/Â§©)",
      boughtUnSupMsg: "ËΩ¶ËæÜ#{id}: Â∑≤‰π∞Êñ≠Êó†ÁõëÁù£TSD($24000)!",
      cannotSubSupMsg: "Êó†Ê≥ï‰∏∫Ê≠§ËΩ¶ËÆ¢ÈòÖÊúâÁõëÁù£TSD„ÄÇ",
      cannotBuySupMsg: "Êó†Ê≥ï‰∏∫Ê≠§ËΩ¶‰π∞Êñ≠ÊúâÁõëÁù£TSD„ÄÇ",
      cannotSubUnSupMsg: "Êó†Ê≥ï‰∏∫Ê≠§ËΩ¶ËÆ¢ÈòÖÊó†ÁõëÁù£TSD„ÄÇ",
      cannotBuyUnSupMsg: "Êó†Ê≥ï‰∏∫Ê≠§ËΩ¶‰π∞Êñ≠Êó†ÁõëÁù£TSD„ÄÇ",
      noModelSelectedMsg: "Êú™ÈÄâÊã©ËΩ¶Âûã„ÄÇ",
      noCashForDownMsg: "È¶ñ‰ªò‰∏çË∂≥„ÄÇ",
      brokeBuyMsg: "‰Ω†Â∑≤Á†¥‰∫ßÔºåÊó†Ê≥ïË¥≠‰π∞ËΩ¶ËæÜ„ÄÇ",
      purchasedCarMsg: "‰Ω†Ë¥≠‰π∞‰∫Ü‰∏ÄËæÜ{model}(#{id})ÔºåÈ¶ñ‰ªò${down}„ÄÇÊØèÊó•Ë¥πÁî®${daily}Ôºå‰∏∫Êúü{term}Â§©„ÄÇ",
      sellConfirmMsg: "Âá∫ÂîÆ{model}(#{id})Ôºü\nËΩ¶ËæÜ‰ª∑Ê†º:${carCost}\nTSD‰π∞Êñ≠:${tsdBuyout}\nÊÄªËÆ°:${total}\nÂîÆ‰ª∑(ÊÄªËÆ°x60%):${salePrice}\nÁ°ÆËÆ§ÂêóÔºü",
      driveUnsupervisedBtn: "È©æÈ©∂Êó†ÁõëÁù£ËΩ¶Èòü",
      noTSDTitle: "Êó†TSD",
      noTSDDesc: "1Â∞èÊó∂È©æÈ©∂ = 1Â∞èÊó∂Áé©ÂÆ∂Êó∂Èó¥",
      supervisedTitle: "TSDÔºàÊúâÁõëÁù£Ôºâ",
      supervisedDesc: "1Â∞èÊó∂È©æÈ©∂ = 0.5Â∞èÊó∂Áé©ÂÆ∂Êó∂Èó¥",
      unsupervisedTitle: "TSDÔºàÊó†ÁõëÁù£Ôºâ",
      unsupervisedDesc: "1Â∞èÊó∂È©æÈ©∂ = 0Â∞èÊó∂Áé©ÂÆ∂Êó∂Èó¥",
      unlockTitle: "Ëß£ÈîÅË¶ÅÊ±Ç",
      unlockDesc: "Êó†ÁõëÁù£TSDÈúÄË¶ÅÊã•ÊúâËá≥Â∞ë2ËæÜËΩ¶",
      dayTemplate: "Á¨¨{day}Â§©",
      chartTitle: "ÊØèÊó•Áé∞ÈáëÊµÅ",
      minDownPaymentMsg: "È¶ñ‰ªòÊúÄ‰Ωé‰∏∫ËΩ¶‰ª∑ÁöÑ30%„ÄÇ",
    }
  };

  const CONFIG = {
    baseDailyExpense: 100,
    playerDailyHours: 8,
    carDailyHours: 16,
    apr: 1.20, // 120% APR
    supervisedDailySub: 100/30,   
    unsupervisedDailySub: 300/30,
    fleetModels: [
      { name: "Type S", cost: 75000 },
      { name: "Type 3", cost: 40000 }, 
      { name: "Type X", cost: 100000 },
      { name: "Type Y", cost: 45000 },
      { name: "FutureCab", cost: 25000 },
      { name: "FutureTruck", cost: 80000 }
    ],
    subscriptionCosts: {
      supervised: 100,
      unsupervised: 300
    },
    buyoutCosts: {
      supervised: 8000,
      unsupervised: 24000
    }
  };

  CONFIG.fleetModels.forEach(m => {
    m.dailyIncome = m.cost * 0.0104;
  });

  // Load saved state from localStorage
  let savedState = JSON.parse(localStorage.getItem('robotaxiState')) || {};

  let currentLang = savedState.currentLang || 'en';
  let day = savedState.day || 1;
  let cash = savedState.cash || 0;
  let playerHours = savedState.playerHours || CONFIG.playerDailyHours; 
  let cars = savedState.cars || [];
  let logs = savedState.logs || [];
  let nextCarId = savedState.nextCarId || 1; 
  let previousCash = savedState.previousCash !== undefined ? savedState.previousCash : cash;

  const dayEl = document.getElementById('day');
  const cashEl = document.getElementById('cash');
  const dailyExpenseEl = document.getElementById('dailyExpense');
  const playerHoursEl = document.getElementById('playerHours');
  const numCarsEl = document.getElementById('numCars');
  const logEl = document.getElementById('log');
  const endDayBtn = document.getElementById('endDayBtn');
  const fleetModelSelect = document.getElementById('fleetModelSelect');
  const buyFleetBtn = document.getElementById('buyFleetBtn');
  const downPaymentRange = document.getElementById('downPaymentRange');
  const downPaymentValue = document.getElementById('downPaymentValue');
  const carListBody = document.getElementById('car-list-body');
  const gameOverMsg = document.getElementById('gameOverMsg');
  const fullPriceDisplay = document.getElementById('fullPriceDisplay');
  const dailyEarningDisplay = document.getElementById('dailyEarningDisplay');
  const loanTermRange = document.getElementById('loanTermRange');
  const loanTermValue = document.getElementById('loanTermValue');
  const dailyCostDisplay = document.getElementById('dailyCostDisplay');
  const driveUnsupervisedBtn = document.getElementById('driveUnsupervisedBtn');
  const langToggle = document.getElementById('langToggle');
  const resetBtn = document.getElementById('resetBtn');

  if(currentLang==='cn') {
    langToggle.classList.add('active');
  }

  // Chart Setup
  let cashflowData = savedState.cashflowData || {
    labels: ['Day 1'],
    datasets: [{
      label: 'Daily Cash Flow',
      data: [0],
      borderColor: '#4834d4',
      backgroundColor: 'rgba(72, 52, 212, 0.1)',
      fill: true,
      tension: 0.4
    }]
  };

  const ctx = document.getElementById('cashflowChart').getContext('2d');
  const cashflowChart = new Chart(ctx, {
    type: 'line',
    data: cashflowData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: LANG_STRINGS[currentLang].chartTitle,
          color: '#4834d4',
          font: {
            size: 16,
            weight: 500
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          grid: {
            display: false
          }
        }
      }
    }
  });

  function saveState() {
    const state = {
      currentLang,
      day,
      cash,
      playerHours,
      cars,
      logs,
      nextCarId,
      previousCash,
      cashflowData
    };
    localStorage.setItem('robotaxiState', JSON.stringify(state));
  }

  function translateUI() {
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      el.textContent = LANG_STRINGS[currentLang][key];
    });
  }

  function getLocalizedMsg(key, params={}){
    let str = LANG_STRINGS[currentLang][key] || key;
    for (let p in params){
      str = str.replace(`{${p}}`, params[p]);
    }
    return str;
  }

  function getCarDailySubscription(car) {
    if (car.unsupervisedOwned) return 0;
    if (car.supervisedOwned) return 0;
    if (car.unsupervisedSubscribed) return CONFIG.unsupervisedDailySub;
    if (car.supervisedSubscribed) return CONFIG.supervisedDailySub;
    return 0;
  }

  function getTotalDailyExpense(){
    let financeSum = 0;
    cars.forEach(car => {
      financeSum += car.dailyPayment;
      financeSum += getCarDailySubscription(car);
    });
    return CONFIG.baseDailyExpense + financeSum;
  }

  function updateUI(){
    const template = LANG_STRINGS[currentLang].dayTemplate;
    dayEl.textContent = template.replace('{day}', day);
    cashEl.textContent = cash.toFixed(2);
    dailyExpenseEl.textContent = getTotalDailyExpense().toFixed(2);
    playerHoursEl.textContent = playerHours;
    numCarsEl.textContent = cars.length;
    updateFinanceDisplay();
    renderCarList();
    updateDriveUnsupervisedButton();
    saveState();
  }

  function logMessage(key, emoji="‚ÑπÔ∏è", params={}){
    logs.push({key, emoji, params});
    if(logs.length > 3){
      logs.shift();
    }
    renderLogs();
    saveState();
  }

  function renderLogs(){
    logEl.innerHTML = '';
    logs.forEach((entry) => {
      const msg = getLocalizedMsg(entry.key, entry.params);
      const div = document.createElement('div');
      div.className = 'log-entry';
      div.innerHTML = `<span class="emoji">${entry.emoji}</span> ${msg}`;
      logEl.appendChild(div);
      setTimeout(() => {
        div.classList.add('show');
      }, 10);
    });
  }

  function getSelectedModel(){
    const index = fleetModelSelect.selectedIndex;
    if(index<0) return null;
    return CONFIG.fleetModels[index];
  }

  function getTSDName(level){
    if(level===0) return LANG_STRINGS[currentLang].tsdNone;
    if(level===1) return LANG_STRINGS[currentLang].tsdSupervised;
    if(level===2) return LANG_STRINGS[currentLang].tsdUnsupervised;
  }

  function getPlayerHourConsumption(tsdLevel, hoursDriven){
    if(tsdLevel === 0) return hoursDriven; 
    if(tsdLevel === 1) return Math.ceil(hoursDriven * 0.5);
    if(tsdLevel === 2) return 0;
  }

  function getMaxDriveHoursForCar(car){
    let playerLimit;
    if(car.tsdLevel === 0) {
      playerLimit = playerHours;
    } else if(car.tsdLevel === 1) {
      playerLimit = 2 * playerHours; 
    } else {
      playerLimit = Infinity; 
    }
    return Math.min(car.carHoursLeft, playerLimit);
  }

  function attemptDrive(car, hoursToDrive) {
    if(hoursToDrive <= 0 || hoursToDrive > car.carHoursLeft){
      logMessage('invalidHoursMsg',"‚ùå");
      return false;
    }
    let neededPlayerHours = getPlayerHourConsumption(car.tsdLevel, hoursToDrive);
    if(neededPlayerHours > playerHours){
      logMessage('notEnoughPlayerHoursMsg',"‚ùå");
      return false;
    }

    playerHours -= neededPlayerHours;
    car.carHoursLeft -= hoursToDrive;
    let earnings = hoursToDrive * car.hourlyRate;
    cash += earnings;
    logMessage('driveCarMsg',"üöï",{hours: hoursToDrive, model:car.modelName, id:car.id, tsd:getTSDName(car.tsdLevel), earnings:earnings.toFixed(2)});
    updateUI();
    return true;
  }

  function addDriveListeners(tr, car){
    const driveBtn = tr.querySelector(`#fleet-driveCar-${car.id}`);
    const hoursInput = tr.querySelector(`#fleet-driveHours-${car.id}`);
    const hoursValueLabel = tr.querySelector(`#fleet-driveValue-${car.id}`);

    const maxHours = getMaxDriveHoursForCar(car);
    hoursInput.max = maxHours.toString();

    function updateValueLabel(){
      hoursValueLabel.textContent = hoursInput.value + "h";
    }

    hoursInput.addEventListener('input', updateValueLabel);

    driveBtn.addEventListener('click', () => {
      let hoursToDrive = parseInt(hoursInput.value) || 0;
      attemptDrive(car, hoursToDrive);
    });

    updateValueLabel();
  }

  function addTSDListeners(td, car) {
    const superviseSubBtn = td.querySelector(`.supervise-sub-${car.id}`);
    const superviseBuyBtn = td.querySelector(`.supervise-buy-${car.id}`);
    const unsuperviseSubBtn = td.querySelector(`.unsupervise-sub-${car.id}`);
    const unsuperviseBuyBtn = td.querySelector(`.unsupervise-buy-${car.id}`);
  
    function canSubscribeSupervised(){
      return car.tsdLevel===0 && !car.supervisedOwned && !car.supervisedSubscribed;
    }
    function canBuySupervised(){
      return car.tsdLevel===0 && !car.supervisedOwned && !car.supervisedSubscribed && cash>=CONFIG.buyoutCosts.supervised;
    }
    function canSubscribeUnsupervised(){
      return car.tsdLevel<2 && !car.unsupervisedOwned && !car.unsupervisedSubscribed && cars.length >= 2;
    }
    function canBuyUnsupervised(){
      return car.tsdLevel<2 && !car.unsupervisedOwned && !car.unsupervisedSubscribed && cash>=CONFIG.buyoutCosts.unsupervised && cars.length >= 2;
    }
  
    superviseSubBtn.disabled = !canSubscribeSupervised() || cash<CONFIG.subscriptionCosts.supervised;
    superviseBuyBtn.disabled = !canBuySupervised();
    unsuperviseSubBtn.disabled = !canSubscribeUnsupervised() || cash<CONFIG.subscriptionCosts.unsupervised;
    unsuperviseBuyBtn.disabled = !canBuyUnsupervised();
  
    superviseSubBtn.addEventListener('click', ()=>{
      if(canSubscribeSupervised() && cash>=CONFIG.subscriptionCosts.supervised){
        car.tsdLevel = 1;
        car.supervisedSubscribed = true;
        gtag('event', 'tsd_upgrade', {
          car_id: car.id,
          old_tsd: 'none',
          new_tsd: 'supervised',
          upgrade_type: 'subscription'
        });
        logMessage('subscribedSupMsg',"ü§ñ",{id:car.id});
        updateUI();
      } else {
        logMessage('cannotSubSupMsg',"‚ùå");
      }
    });
  
    superviseBuyBtn.addEventListener('click', ()=>{
      if(canBuySupervised()){
        cash -= CONFIG.buyoutCosts.supervised;
        car.tsdLevel = 1;
        car.supervisedOwned = true;
        car.supervisedSubscribed = false;
        gtag('event', 'tsd_upgrade', {
          car_id: car.id,
          old_tsd: 'none',
          new_tsd: 'supervised',
          upgrade_type: 'buyout',
          cost: CONFIG.buyoutCosts.supervised
        });
        logMessage('boughtSupMsg',"üí∞",{id:car.id});
        updateUI();
      } else {
        logMessage('cannotBuySupMsg',"‚ùå");
      }
    });
  
    unsuperviseSubBtn.addEventListener('click', ()=>{
      if(canSubscribeUnsupervised() && cash>=CONFIG.subscriptionCosts.unsupervised){
        car.tsdLevel = 2;
        car.unsupervisedSubscribed = true;
        car.supervisedSubscribed = false;
        car.supervisedOwned = false;
        logMessage('subscribedUnSupMsg',"ü§ñ",{id:car.id});
        updateUI();
      } else {
        logMessage('cannotSubUnSupMsg',"‚ùå");
      }
    });
  
    unsuperviseBuyBtn.addEventListener('click', ()=>{
      if(canBuyUnsupervised()){
        cash -= CONFIG.buyoutCosts.unsupervised;
        car.tsdLevel = 2;
        car.unsupervisedOwned = true;
        car.unsupervisedSubscribed = false;
        car.supervisedSubscribed = false;
        car.supervisedOwned = false;
        logMessage('boughtUnSupMsg',"üí∞",{id:car.id});
        updateUI();
      } else {
        logMessage('cannotBuyUnSupMsg',"‚ùå");
      }
    });
  
    if (car.supervisedOwned) {
      superviseSubBtn.classList.add('tsd-active');
      superviseBuyBtn.classList.add('tsd-active');
    } else if (car.supervisedSubscribed) {
      superviseSubBtn.classList.add('tsd-active');
      superviseBuyBtn.classList.remove('tsd-active');
    } else {
      superviseSubBtn.classList.remove('tsd-active');
      superviseBuyBtn.classList.remove('tsd-active');
    }

    if (car.unsupervisedOwned) {
      unsuperviseSubBtn.classList.add('tsd-active');
      unsuperviseBuyBtn.classList.add('tsd-active');
    } else if (car.unsupervisedSubscribed) {
      unsuperviseSubBtn.classList.add('tsd-active');
      unsuperviseBuyBtn.classList.remove('tsd-active');
    } else {
      unsuperviseSubBtn.classList.remove('tsd-active');
      unsuperviseBuyBtn.classList.remove('tsd-active');
    }
  }

  function addSellListener(td, car){
    const sellBtn = td.querySelector(`.sell-car-button[data-car-id="${car.id}"]`);
    sellBtn.addEventListener('click', ()=>{
      let carCost = getCarCost(car);
      let tsdBuyout = getTsdBuyoutCost(car);
      let total = carCost + tsdBuyout;
      let salePrice = total * 0.6;
      let msg = getLocalizedMsg('sellConfirmMsg',{
        model:car.modelName,
        id:car.id,
        carCost:carCost.toFixed(2),
        tsdBuyout:tsdBuyout.toFixed(2),
        total:total.toFixed(2),
        salePrice:salePrice.toFixed(2)
      });
      if(confirm(msg)){
        cash += salePrice;
        cars = cars.filter(c=>c.id!==car.id);
        updateUI();
      }
    });
  }

  function getCarCost(car){
    let model = CONFIG.fleetModels.find(m=>m.name===car.modelName);
    return model.cost;
  }

  function getTsdBuyoutCost(car){
    if(car.unsupervisedOwned) return CONFIG.buyoutCosts.unsupervised;
    if(car.supervisedOwned) return CONFIG.buyoutCosts.supervised;
    return 0;
  }

  function renderCarRow(car){
    const tsdName = getTSDName(car.tsdLevel);
    const subSupText = getLocalizedMsg('subSupBtn');
    const buySupText = getLocalizedMsg('buySupBtn');
    const subUnSupText = getLocalizedMsg('subUnSupBtn');
    const buyUnSupText = getLocalizedMsg('buyUnSupBtn');

    let idDisplay = `#${car.id}`;
    if(car.financed && car.daysPaid < car.loanTermDays) {
      idDisplay += ` (${car.daysPaid}/${car.loanTermDays})`;
    }

    return `
      <tr>
        <td>${idDisplay}</td>
        <td>${car.modelName}</td>
        <td>$${car.hourlyRate.toFixed(2)}/hr</td>
        <td>${tsdName}</td>
        <td>${car.carHoursLeft}h</td>
        <td>
          <input type="range" min="0" max="${car.carHoursLeft}" value="${car.carHoursLeft}" step="1" id="fleet-driveHours-${car.id}">
          <span id="fleet-driveValue-${car.id}">0h</span>
        </td>
        <td>
          <div class="car-actions">
            <button id="fleet-driveCar-${car.id}">${getLocalizedMsg('tableDriveAction')}</button>
            <button class="sell-car-button" data-car-id="${car.id}" data-i18n="tableSell">${getLocalizedMsg('tableSell')}</button>
          </div>
        </td>
        <td>
          <div class="tsd-actions">
            <div class="tsd-action-row">
              <button class="supervise-sub-${car.id}">${subSupText}</button>
              <button class="supervise-buy-${car.id}">${buySupText}</button>
            </div>
            <div class="tsd-action-row">
              <button class="unsupervise-sub-${car.id}">${subUnSupText}</button>
              <button class="unsupervise-buy-${car.id}">${buyUnSupText}</button>
            </div>
          </div>
        </td>
      </tr>
    `;
  }

  function renderCarList(){
    carListBody.innerHTML = '';
    cars.forEach(car => {
      const html = renderCarRow(car);
      const temp = document.createElement('tbody');
      temp.innerHTML = html;
      const tr = temp.querySelector('tr');
      carListBody.appendChild(tr);
      addDriveListeners(tr, car);
      const tsdTd = tr.querySelectorAll('td')[7];
      addTSDListeners(tsdTd, car);
      const sellTd = tr.querySelectorAll('td')[6];
      addSellListener(sellTd, car);
    });
  }

  function amortizationDailyPayment(principal, annualInterestRate, termDays){
    const r = annualInterestRate / 365; 
    const pow = Math.pow((1+r), termDays);
    const numerator = r * pow;
    const denominator = pow - 1;
    if(denominator === 0) return principal / termDays;
    return principal*(numerator/denominator);
  }

  endDayBtn.addEventListener('click', function(){
    let expense = getTotalDailyExpense();
    cash -= expense;

    let dailyCashFlow = cash - previousCash;
    previousCash = cash; 

    cashflowData.labels.push('Day ' + (day + 1));
    cashflowData.datasets[0].data.push(dailyCashFlow);
    cashflowChart.update();

    cars.forEach(car=>{
      if(car.financed && car.daysPaid < car.loanTermDays) {
        car.daysPaid++;
        if(car.daysPaid >= car.loanTermDays) {
          car.dailyPayment = 0;
        }
      }
    });

    if(cash < 0) {
      logMessage('brokeMsg',"üíÄ");
      gameOverMsg.style.display = 'block';
      disableAllActions();
      return;
    }

    day++;
    playerHours = CONFIG.playerDailyHours;
    cars.forEach(car => {
      car.carHoursLeft = CONFIG.carDailyHours;
    });

    gtag('event', 'end_day', {
      day: day,
      remaining_cash: cash,
      cars_owned: cars.length,
      daily_cashflow: dailyCashFlow
    });

    logMessage('dayEndedMsg',"üìÖ",{cash:cash.toFixed(2), day:day});
    updateUI();
  });

  function updateDriveUnsupervisedButton(){
    const hasUnsupervisedCar = cars.some(car=>car.tsdLevel===2);
    driveUnsupervisedBtn.style.display = hasUnsupervisedCar ? 'inline-block' : 'none';
  }

  driveUnsupervisedBtn.addEventListener('click', ()=>{
    cars.forEach(car=>{
      if(car.tsdLevel>=1 && car.carHoursLeft>0){
        let hoursToDrive = car.carHoursLeft;
        if(car.tsdLevel===2){
          attemptDrive(car, hoursToDrive);
        } else if(car.tsdLevel===1) {
          let neededPH = getPlayerHourConsumption(1, hoursToDrive);
          if(neededPH > playerHours){
            let maxH = Math.floor(playerHours * 2);
            let driveH = Math.min(hoursToDrive, maxH);
            if(driveH > 0){
              attemptDrive(car, driveH);
            }
          } else {
            attemptDrive(car, hoursToDrive);
          }
        }
      }
    });
    updateUI();
  });

  function updateFinanceDisplay() {
    const model = getSelectedModel();
    if(model) {
      const minDownPayment = model.cost * 0.3; // Changed from 0.1 to 0.3 for 30% minimum down payment
      downPaymentRange.min = minDownPayment;  
      downPaymentRange.max = model.cost;
      
      let downPayment = Math.max(minDownPayment, parseFloat(downPaymentRange.value) || 0);
      downPaymentRange.value = downPayment;
      let termDays = parseInt(loanTermRange.value);

      let financed = Math.max(0, model.cost - downPayment);
      let dailyPayment = 0;
      if(financed > 0 && termDays>0) {
        dailyPayment = amortizationDailyPayment(financed, CONFIG.apr, termDays);
      }

      dailyCostDisplay.textContent = "$" + dailyPayment.toFixed(2);
      let hourlyRate = (model.dailyIncome / CONFIG.carDailyHours);
      dailyEarningDisplay.textContent = "$" + hourlyRate.toFixed(2);
      fullPriceDisplay.textContent = "$" + model.cost.toFixed(2);
      downPaymentValue.textContent = downPayment.toFixed(2);
    } else {
      downPaymentRange.value = 0;
      downPaymentValue.textContent = "0";
      fullPriceDisplay.textContent = "$0";
      dailyCostDisplay.textContent = "$0";
      dailyEarningDisplay.textContent = "$0";
    }
  }

  downPaymentRange.addEventListener('input', function(){
    updateFinanceDisplay();
  });

  loanTermRange.addEventListener('input', function(){
    loanTermValue.textContent = loanTermRange.value;
    updateFinanceDisplay();
  });

  buyFleetBtn.addEventListener('click', function(){
    if(cash < 0) {
      logMessage('brokeBuyMsg',"‚ùå");
      return;
    }
    const model = getSelectedModel();
    if(!model) {
      logMessage('noModelSelectedMsg',"‚ùå");
      return;
    }

    let downPayment = parseFloat(downPaymentRange.value) || 0;
    const minDownPayment = model.cost * 0.3; // Changed from 0.1 to 0.3 for 30% minimum down payment
    
    if(downPayment < minDownPayment) {
      logMessage('minDownPaymentMsg',"‚ùå");
      return;
    }

    let termDays = parseInt(loanTermRange.value);
    if(downPayment > cash) {
      logMessage('noCashForDownMsg',"‚ùå");
      return;
    }

    let financed = Math.max(0, model.cost - downPayment);
    let dailyPayment = 0;
    if(financed > 0 && termDays>0) {
      dailyPayment = amortizationDailyPayment(financed, CONFIG.apr, termDays);
    }

    cash -= downPayment;

    const hourlyRate = model.dailyIncome / CONFIG.carDailyHours;
    const newCarId = nextCarId++;
    cars.push({
      id: newCarId,
      modelName: model.name,
      hourlyRate: hourlyRate,
      carHoursLeft: CONFIG.carDailyHours,
      tsdLevel: 0,
      supervisedSubscribed: false,
      supervisedOwned: false,
      unsupervisedSubscribed: false,
      unsupervisedOwned: false,
      financed: financed > 0,
      dailyPayment: dailyPayment,
      loanTermDays: termDays,
      daysPaid: 0
    });

    gtag('event', 'purchase_car', {
      model: model.name,
      cost: model.cost,
      down_payment: downPayment,
      term_days: termDays
    });

    logMessage('purchasedCarMsg',"üöò",{model:model.name,id:newCarId,down:downPayment.toFixed(2),daily:dailyPayment.toFixed(2),term:termDays});
    updateUI();
  });

  function disableAllActions(){
    gtag('event', 'game_over', {
      final_day: day,
      final_cash: cash,
      cars_owned: cars.length
    });

    endDayBtn.disabled = true;
    buyFleetBtn.disabled = true;
    fleetModelSelect.disabled = true;
    downPaymentRange.disabled = true;
    loanTermRange.disabled = true;
    driveUnsupervisedBtn.disabled = true;
    document.querySelectorAll('button').forEach(btn=>{
      btn.disabled = true;
    });
  }

  CONFIG.fleetModels.forEach((m,i) => {
    let opt = document.createElement('option');
    opt.value = i;
    opt.textContent = m.name;
    fleetModelSelect.appendChild(opt);
  });

  fleetModelSelect.addEventListener('change', function(){
    updateFinanceDisplay();
  });

  // Only start with Type Y if not loaded from storage (no cars)
  if(cars.length===0) {
    (function startWithTypeY(){
      let model = CONFIG.fleetModels.find(m=>m.name==="Type Y");
      let hourlyRate = model.dailyIncome / CONFIG.carDailyHours;
      cars.push({
        id: nextCarId++,
        modelName: model.name,
        hourlyRate: hourlyRate,
        carHoursLeft: CONFIG.carDailyHours,
        tsdLevel: 0,
        supervisedSubscribed: false,
        supervisedOwned: false,
        unsupervisedSubscribed: false,
        unsupervisedOwned: false,
        financed: false,
        dailyPayment:0,
        loanTermDays:0,
        daysPaid:0
      });
      updateUI();
      logMessage('startCarMsg',"üéâ");
    })();
  } else {
    updateUI();
    renderLogs();
  }

  langToggle.addEventListener('click', () => {
    langToggle.classList.toggle('active');
    currentLang = langToggle.classList.contains('active') ? 'cn' : 'en';
    gtag('event', 'language_change', {
      language: currentLang
    });
    translateUI();
    updateUI();
    renderLogs();
    updateChartTitle();
  });

  resetBtn.addEventListener('click', () => {
    const message = currentLang === 'cn' 
      ? "ÊÇ®Á°ÆÂÆöË¶ÅÈáçÁΩÆÂêóÔºüËøôÂ∞ÜÂà†Èô§ÊâÄÊúâËøõÂ∫¶„ÄÇ"
      : "Are you sure you want to reset? This will erase all your progress.";
    if (confirm(message)) {
      localStorage.clear();
      location.reload();
    }
  });

  function updateChartTitle() {
    cashflowChart.options.plugins.title.text = LANG_STRINGS[currentLang].chartTitle;
    cashflowChart.update();
  }

  translateUI();
  updateFinanceDisplay();
  if(logs.length===0) {
    logMessage('welcomeMsg',"üëã");
  }

})();
</script>
</body>
</html>
